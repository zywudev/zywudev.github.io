<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="贾小昆">
<meta property="og:url" content="http://wuzhangyang.com/page/4/index.html">
<meta property="og:site_name" content="贾小昆">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="贾小昆">
<meta name="twitter:card" content="summary"><title>贾小昆</title><link ref="canonical" href="http://wuzhangyang.com/page/4/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><script src="https://www.googletagmanager.com/gtag/js?id=UA-127464210-1" async=""></script><script>if (window.location.hostname !== 'localhost') {
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'UA-127464210-1');
}</script><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: undefined,
  header: undefined,
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.1.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/10/23/android-interview-1-how-handler-avoid-memory-leaks/">Android 面试题（1）：使用 Handler 时如何有效地避免内存泄漏问题？</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-10-23</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">994</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">6分</span></span></div></header><div class="post-body"><div class="post-excerpt"><blockquote>
<p>这一系列文章致力于为 Android 开发者查漏补缺，面试准备。</p>
<p>所有文章首发于公众号「JaqenAndroid」，长期持续更新。</p>
<p>由于笔者水平有限，总结的答案难免会出现错误，欢迎留言指出，大家一起学习、交流、进步。</p>
</blockquote>

        <h2 id="什么是内存泄漏？">
          <a href="#什么是内存泄漏？" class="heading-link"><i class="fas fa-link"></i></a>什么是内存泄漏？</h2>
      <p>Java 中采用可达性分析算法判断一个对象是否可被回收。</p>
<p>基本思路是这样的：</p>
<p>通过一系列称为 “GC Roots” 的对象作为起始点，从这个节点向下搜索，搜索走过的路径就是引用链，当一个对象到 GC Roots 没有任何引用链相连，也就是从 GC Roots 到这个对象不可达，则这个对象不可达，可以被回收。</p>
<p>可作为 GC Roots 的对象有：</p>
<ul>
<li><p>虚拟机栈中的引用的对象</p>
</li>
<li><p>方法区的静态变量和常量引用的对象</p>
</li>
<li><p>本地方法栈中 JNI 引用的对象</p>
</li>
</ul>
<p><strong>当一个对象不需要在再使用了，本该被回收时， 而另外一个正在使用的对象持有它的引用从而导致它不能被回收，这就导致本该被回收的对象不能被回收而停留在堆内存中，内存泄漏就产生了。</strong> </p>

        <h2 id="Handler-是如何造成内存泄漏的？">
          <a href="#Handler-是如何造成内存泄漏的？" class="heading-link"><i class="fas fa-link"></i></a>Handler 是如何造成内存泄漏的？</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 处理数据</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        loadData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 耗时任务</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">        Message message = Message.obtain();</span><br><span class="line">        mHandler.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p> 上面是一段简单的 Handler 的使用。 这种方式有可能造成内存泄漏吗？答案是有可能的。我们来分析下造成内存泄漏的原因？</p>
<p>我们知道 Java中非静态内部类会隐式持有外部类的引用，所以这里创建的 Handler 隐式持有外部类 MainActivity 的引用。</p>
<p>而 Handler 一般用来处理后台线程任务的执行结果，如果在线程任务之慈宁宫过程中，用户关闭了 Activity，此时线程尚未执行完，而该线程持有 Handler 的引用，Handler 又持有 Activity 的引用，就导致了 Activity 无法被回收（即内存泄漏）。</p>
<p>还有一种情况，如果你调用 Handler 的 <code>postDelay()</code> 方法执行了延时任务， 该方法会将你的Handler 装入一个 Message，并把这条 Message 推到 MessageQueue 中，那么在你设定的 delay 到达之前，会有一条 MessageQueue -&gt; Message -&gt; Handler -&gt; Activity 的链，导致你的 Activity 被持有引用而无法被回收。 </p>

        <h2 id="如果解决-Handler-导致的内存泄漏问题？">
          <a href="#如果解决-Handler-导致的内存泄漏问题？" class="heading-link"><i class="fas fa-link"></i></a>如果解决 Handler 导致的内存泄漏问题？</h2>
      <p><strong>方法 1、静态内部类 + 弱引用</strong></p>
<p>既然非静态内部类持有外部类的引用，那么可以将 Handler 声明为静态内部类，Handler 也就不再持有 Activity 的引用，所以 Activity 可以随便被回收。代码如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>此时 Handler 不再持有 Activity 的引用，导致 Handler 无法操作 Activity 中对象，所以可以在 Handler 中添加一个对 Activity 的弱引用（ WeakReference ）：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    WeakReference&lt;Activity &gt; mActivityReference;</span><br><span class="line"></span><br><span class="line">    MyHandler(Activity activity) &#123;</span><br><span class="line">        mActivityReference= <span class="keyword">new</span> WeakReference&lt;Activity&gt;(activity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Activity activity = mActivityReference.get();</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>弱引用的特点是： 在垃圾回收器一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。 所以用户在关闭 Activity 之后，就算后台线程还没结束，但由于仅有一条来自 Handler 的弱引用指向 Activity，Activity 也会被回收掉。这样，内存泄露的问题就不会出现了。 </p>
<p><strong>方法2： 通过程序逻辑来进行保护</strong></p>
<p> 在 Activity 被销毁时及时清除消息，从而及时回收 Activity，避免内存泄漏问题。 </p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (mHandler != <span class="keyword">null</span>)  &#123;</span><br><span class="line">        mHandler.removeCallbacksAndMessages(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>







</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/10/14/compile-ijkplayer/">ijkplayer 编译实践</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-10-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">790</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">6分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>记录 ijkplayer 的编译过程，以及遇到的问题，有需要的朋友可以参考。</p>

        <h2 id="编译环境">
          <a href="#编译环境" class="heading-link"><i class="fas fa-link"></i></a>编译环境</h2>
      
        <h3 id="Linux-环境">
          <a href="#Linux-环境" class="heading-link"><i class="fas fa-link"></i></a>Linux 环境</h3>
      <p>由于主机是 Windows 系统，所以使用 VMware 安装了 Ubuntu 18.0.4 系统。</p>
<p>VMware 安装 Ubuntu 系统的安装步骤网上非常多，这篇文章比较详细，没有经验的可以参考。</p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/38797088">https://zhuanlan.zhihu.com/p/38797088</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="Android-SDK">
          <a href="#Android-SDK" class="heading-link"><i class="fas fa-link"></i></a>Android SDK</h3>
      <p>下载地址：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.com/studio#downloads">https://developer.android.com/studio#downloads</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="Android-NDK">
          <a href="#Android-NDK" class="heading-link"><i class="fas fa-link"></i></a>Android NDK</h3>
      <p>下载地址：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk/downloads/older_releases.html">https://developer.android.google.cn/ndk/downloads/older_releases.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>注意 NDK 的最小版本支持是 10e，目前不支持 NDK 15！我这边下载的是 <code>android-ndk-r14b</code>。</p>
<p>Android SDK 和 Android NDK 下载解压后，需要配置环境变量，可以参考我写的这篇文章。</p>
<p><a href="http://wuzhangyang.com/2019/10/14/ubuntu-android-studio/">http://wuzhangyang.com/2019/10/14/ubuntu-android-studio/</a></p>

        <h3 id="安装-git-和-yasm">
          <a href="#安装-git-和-yasm" class="heading-link"><i class="fas fa-link"></i></a>安装 git 和 yasm</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git</span><br><span class="line">sudo apt install yasm</span><br></pre></td></tr></table></div></figure>

<p>注意，如果安装报错，先要执行 <code>sudo apt update</code> 进行更新。</p>

        <h2 id="开始编译">
          <a href="#开始编译" class="heading-link"><i class="fas fa-link"></i></a>开始编译</h2>
      
        <h3 id="拉取-ijkplayer-源码">
          <a href="#拉取-ijkplayer-源码" class="heading-link"><i class="fas fa-link"></i></a>拉取 ijkplayer 源码</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Bilibili/ijkplayer.git ijkplayer-android</span><br><span class="line">cd ijkplayer-android</span><br><span class="line">git checkout -B latest k0.8.8</span><br></pre></td></tr></table></div></figure>


        <h3 id="初始化-android">
          <a href="#初始化-android" class="heading-link"><i class="fas fa-link"></i></a>初始化 android</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./init-android.sh</span><br></pre></td></tr></table></div></figure>


        <h3 id="初始化-openssl-支持-https">
          <a href="#初始化-openssl-支持-https" class="heading-link"><i class="fas fa-link"></i></a>初始化 openssl 支持 https</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./init-android-openssl.sh</span><br></pre></td></tr></table></div></figure>


        <h3 id="配置编解码器格式支持">
          <a href="#配置编解码器格式支持" class="heading-link"><i class="fas fa-link"></i></a>配置编解码器格式支持</h3>
      <p>默认为最少支持，如果足够你使用，可以跳过这一步，否则可以改为以下配置:</p>
<ul>
<li><p><code>module-default.sh</code> 更多的编解码器/格式</p>
</li>
<li><p><code>module-lite-hevc.sh</code> 较少的编解码器/格式(包括 hevc)</p>
</li>
<li><p><code>module-lite.sh</code> 较少的编解码器/格式(默认情况)</p>
</li>
</ul>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入 config 目录</span></span><br><span class="line">cd config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除当前的 module.sh 文件</span></span><br><span class="line">rm module.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建软链接 module.sh 指向 module-default.sh</span></span><br><span class="line">ln -s module-default.sh module.sh</span><br></pre></td></tr></table></div></figure>


        <h3 id="编译-openssl">
          <a href="#编译-openssl" class="heading-link"><i class="fas fa-link"></i></a>编译 openssl</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入 android/contrib 目录</span></span><br><span class="line">cd android/contrib</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除 openssl 的编译文件</span></span><br><span class="line">./compile-openssl.sh clean</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译 openssl</span></span><br><span class="line">./compile-openssl.sh all</span><br></pre></td></tr></table></div></figure>

<p><code>./compile-openssl.sh</code> 后跟 <code>all</code> 表示编译所有 CPU 架构的 so 库， 如果只编译指定 CPU 架构的 so 库，后面就跟 CPU 架构，比如：<code>./compile-ffmpeg.sh armv7a</code>。</p>
<p>这里，在执行 <code>./compile-openssl.sh all</code> 时出现了编译错误：<strong>ERROR: Failed to create toolchain.</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">jaqen@jaqen-virtual-machine:~/Android/Projects/ijkplayer-android/android/contrib$ ./compile-openssl.sh all</span><br><span class="line">====================</span><br><span class="line">[*] check archs</span><br><span class="line">====================</span><br><span class="line">FF_ALL_ARCHS = armv5 armv7a arm64 x86 x86_64</span><br><span class="line">FF_ACT_ARCHS = armv5 armv7a arm64 x86 x86_64</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">[*] make NDK standalone toolchain</span><br><span class="line">--------------------</span><br><span class="line">build on Linux x86_64</span><br><span class="line">ANDROID_NDK=/home/jaqen/Android/Sdk/android-ndk-r14b</span><br><span class="line">IJK_NDK_REL=14.1.3816874</span><br><span class="line">NDKr14.1.3816874 detected</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">[*] make NDK standalone toolchain</span><br><span class="line">--------------------</span><br><span class="line">build on Linux x86_64</span><br><span class="line">ANDROID_NDK=/home/jaqen/Android/Sdk/android-ndk-r14b</span><br><span class="line">IJK_NDK_REL=14.1.3816874</span><br><span class="line">NDKr14.1.3816874 detected</span><br><span class="line">HOST_OS=linux</span><br><span class="line">HOST_EXE=</span><br><span class="line">HOST_ARCH=x86_64</span><br><span class="line">HOST_TAG=linux-x86_64</span><br><span class="line">HOST_NUM_CPUS=4</span><br><span class="line">BUILD_NUM_CPUS=8</span><br><span class="line">Auto-config: --arch=arm</span><br><span class="line">ERROR: Failed to create toolchain.</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>解决办法是安装 python 后再执行编译。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python</span><br></pre></td></tr></table></div></figure>


        <h3 id="编译-ffmpeg">
          <a href="#编译-ffmpeg" class="heading-link"><i class="fas fa-link"></i></a>编译 ffmpeg</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 清除 ffmpeg 的编译文件</span></span><br><span class="line">./compile-ffmpeg.sh clean</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译 ffmpeg</span></span><br><span class="line">./compile-ffmpeg.sh all</span><br></pre></td></tr></table></div></figure>

<p>执行 <code>./compile-ffmpeg.sh all</code> 时出现编译错误：<strong>linux/perf_event.h: No such file or directory</strong>。</p>
<p>解决办法是在 <code>config</code> 文件夹下的 <code>module.sh</code> 文件中加入下面两句：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export COMMON_FF_CFG_FLAGS=&quot;$COMMON_FF_CFG_FLAGS --disable-linux-perf&quot;</span><br><span class="line">export COMMON_FF_CFG_FLAGS=&quot;$COMMON_FF_CFG_FLAGS --disable-bzlib&quot;</span><br></pre></td></tr></table></div></figure>

<p>再重新执行编译。</p>

        <h3 id="编译-ijkplayer">
          <a href="#编译-ijkplayer" class="heading-link"><i class="fas fa-link"></i></a>编译 ijkplayer</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入 android 目录</span></span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译 ijkplayer</span></span><br><span class="line">./compile-ijk.sh all</span><br></pre></td></tr></table></div></figure>

<p> 编译完成之后，在 <code>android/ijkpleyer</code> 文件夹的对应架构文件下，在<code>/src/main/libs/架构名/</code>下生成<code>libijkplayer.so</code>、<code>libijkffmpeg.so</code>、<code>libijksdl.so</code> 三个文件。 </p>
<p><img src="/2019/10/14/compile-ijkplayer/ijkplayer_so.png" alt="ijkplayer_so"></p>
<p>至此，ijkplayer 的编译工作就全部完成了。</p>
<p>编译过程中遇到问题的朋友欢迎留言交流。</p>
<p>不想编译的朋友，可以在公众号 「贾小昆」后台回复 <code>ijk</code> 获取 so 包。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/10/14/ubuntu-android-studio/">Ubuntu 下 Android Studio 安装与配置</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-10-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">469</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">3分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>本文主要记录一下 Ubuntu 环境下 Android Studio 的安装和配置，方便查找使用。</p>

        <h2 id="Android-Studio-安装">
          <a href="#Android-Studio-安装" class="heading-link"><i class="fas fa-link"></i></a>Android Studio 安装</h2>
      <p>Android Studio 下载地址：</p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.com/studio">https://developer.android.com/studio</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>下载后，直接解压即可。</p>
<p>然后进入 <code>/android-studio/bin/</code> 文件下，会看到一个<code>studio.sh</code>的执行文件。</p>
<p><img src="/2019/10/14/ubuntu-android-studio/ubuntu_android_studio1.png" alt="ubuntu_android_studio1"></p>
<p>终端命令进入 <code>/android-studio/bin/ </code> , 执行命令 <code>./studio.sh</code> ，进行安装即可，没啥好说的。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd android-studio/bin</span><br><span class="line">./studio.sh</span><br></pre></td></tr></table></div></figure>


        <h2 id="Android-Studio-配置">
          <a href="#Android-Studio-配置" class="heading-link"><i class="fas fa-link"></i></a>Android Studio 配置</h2>
      
        <h3 id="配置-Android-环境变量">
          <a href="#配置-Android-环境变量" class="heading-link"><i class="fas fa-link"></i></a>配置 Android 环境变量</h3>
      <p>终端命令：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit ~/.bashrc</span><br></pre></td></tr></table></div></figure>

<p>在文档末尾添加：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置 Android 环境变量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 你的ADB路径</span></span><br><span class="line">ADB=/home/jaqen/Android/Sdk/platform-tools</span><br><span class="line">export ADB</span><br><span class="line"><span class="meta">#</span><span class="bash"> 你的ANDROID_NDK和ANDROID_SDK 路径</span></span><br><span class="line">ANDROID_NDK=/home/jaqen/Android/Sdk/android-ndk-r14b</span><br><span class="line">export ANDROID_NDK</span><br><span class="line">ANDROID_SDK=/home/jaqen/Android/Sdk</span><br><span class="line">export ANDROID_SDK </span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入到PATH路径</span></span><br><span class="line">PATH=$&#123;PATH&#125;:$&#123;ADB&#125;:$&#123;ANDROID_NDK&#125;:$&#123;ANDROID_SDK&#125;</span><br></pre></td></tr></table></div></figure>

<p>NDK 需要单独去下载：</p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk/downloads/older_releases.html">https://developer.android.google.cn/ndk/downloads/older_releases.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>注意需要执行下面的命令，使修改生效。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></div></figure>


        <h3 id="设置-Android-Studio-别名">
          <a href="#设置-Android-Studio-别名" class="heading-link"><i class="fas fa-link"></i></a>设置 Android Studio 别名</h3>
      <figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 你的android studio安装路径</span></span><br><span class="line">alias as=/home/jaqen/Downloads/android-studio-ide-191.5900203-linux/android-studio/bin/studio.sh</span><br></pre></td></tr></table></div></figure>

<p>然后，就可以用命令行执行命令 <code>as</code> 启动 Android Studio 了。</p>

        <h3 id="制作启动图标">
          <a href="#制作启动图标" class="heading-link"><i class="fas fa-link"></i></a>制作启动图标</h3>
      <p>制作一个启动图标，方便鼠标点击启动。</p>
<p>终端命令进入 <code>/android-studio/bin/ </code> ，新建一个 <code>Studio.desktop</code> 文件，然后打开。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit Studio.desktop</span><br></pre></td></tr></table></div></figure>

<p>输入以下内容：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Name=AndroidStudio</span><br><span class="line">Type=Application</span><br><span class="line"><span class="meta">#</span><span class="bash"> 你的Android Studio 图标路径</span></span><br><span class="line">Icon=/home/jaqen/Downloads/android-studio-ide-191.5900203-linux/android-studio/bin/studio.png</span><br><span class="line"><span class="meta">#</span><span class="bash"> 你的Android Studio 启动路径</span></span><br><span class="line">Exec=sh /home/jaqen/Downloads/android-studio-ide-191.5900203-linux/android-studio/bin/studio.sh</span><br></pre></td></tr></table></div></figure>

<p>保存。</p>
<p>右键该文件 &gt; 属性 &gt; 权限 &gt; 选择允许作为程序执行文件，这个时候文件名和图标都会相应改变了。</p>
<p>好了，双击可以启动 Android Studio 了。</p>
<p>将启动图标添加到 <code>/usr/share/applications/</code>下。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv /home/jaqen/Downloads/android-studio-ide-191.5900203-linux/android-studio/bin/Studio.desktop /usr/share/applications</span><br></pre></td></tr></table></div></figure>

<p>终端命令：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nautilus  usr/share/applications</span><br></pre></td></tr></table></div></figure>

<p><img src="/2019/10/14/ubuntu-android-studio/ubuntu_android_studio2.png" alt="ubuntu_android_studio2"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/10/08/jiucai/">读《韭菜的自我修养》</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-10-08</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">9分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>近来读到李笑来老师的一本书，光书名就很有意思，叫做《韭菜的自我修养》。</p>
<p>李笑来不亏是曾经当过名师的人，整本书的内容浅显易懂，可读性很高。非常适合大多数新入门的投资者好好读读。</p>
<p>我挑重点概要总结了一些精要，和你们分享下。</p>

        <h2 id="什么是韭菜？">
          <a href="#什么是韭菜？" class="heading-link"><i class="fas fa-link"></i></a>什么是韭菜？</h2>
      <p>书中一开始的定义是：“在交易市场中没赚到钱甚至赔钱的势单力薄的散户”，他们一般是缺乏基本的阅读能力，比如购买所有的产品都不会去看说明书的人，他们拒绝学习，拿来主义，伸手党，他们一进场不管三七二十一就买买买。</p>

        <h2 id="一买就跌，一卖就涨？">
          <a href="#一买就跌，一卖就涨？" class="heading-link"><i class="fas fa-link"></i></a>一买就跌，一卖就涨？</h2>
      <p>交易市场有个诡异的定律就是：</p>
<p>你一买，它就开始跌；你一卖，它就开始涨。</p>
<p>为什么？</p>
<p>因为每一次行情结束的根本原因是”入场资金枯竭“。换言之，当连街边卖茶叶蛋的大妈都在讨论股票的时候，那么股市的“入场资金”已经到了枯竭边缘……你想啊，连你这个八竿子打不着的人都知道了，要冲进来赚钱的时候，那交易市场的行情是不是到头了？</p>
<p>对于新手，两句重要的话。</p>
<p>连你都开始进场的时候，牛市就要结束了；</p>
<p>你就应该干看着，啥都不买……到了熊市，等到大家都骂娘的时候，再开始买买买！</p>

        <h2 id="亡羊补牢犹未晚矣">
          <a href="#亡羊补牢犹未晚矣" class="heading-link"><i class="fas fa-link"></i></a>亡羊补牢犹未晚矣</h2>
      <p>很多新手，一进场就犯了个大错，不知道牛市即将结束，激动的“买买买”，自然就被套住了。</p>
<p>更可怕的错误是，一进场就把自己的钱花光了！</p>
<p>还有更可怕的就是，一进场就连借来的钱都花光了！</p>
<p>对于聪明人来说，他们会怎么做？</p>
<p>还有钱的话，在漫长的熊市里，慢慢补仓，降低成本建仓。钱不够的话，就在场外拼命赚钱。</p>

        <h2 id="投机者和投资者的区别">
          <a href="#投机者和投资者的区别" class="heading-link"><i class="fas fa-link"></i></a>投机者和投资者的区别</h2>
      <p>区分投机者和投资者的依据在于：</p>
<p> 投机者拒绝学习，投资者善于学习。</p>
<p>投资者交易之前，认真研究，深入学习；交易过后，无论输赢，都要总结归纳，修正自己的观念和思考，以便完善下一次的决策——这么做的人，在我眼里都是投资者，哪怕他们是“快进快出”。</p>
<p>而投机者呢？他们拒绝学习，最好有人告诉他怎么买就行，伸手党。这其实就是韭菜，是傻逼。</p>
<p>思考带来决策，决策带来行动，行动改变命运——这是大实话。</p>

        <h2 id="韭菜错误的观点">
          <a href="#韭菜错误的观点" class="heading-link"><i class="fas fa-link"></i></a>韭菜错误的观点</h2>
      <p>韭菜都认同一个实际上错误的观点：</p>
<p>所谓的交易，是一种“零和游戏”。</p>
<p>也就是说，他们相信自己赚到的钱，是别人赔掉的钱；或者反过来说，他们自己赔掉了多少钱，一定被别人赚走了同样数额的钱。</p>
<p>这是一种错误的观点：</p>
<p>在牛市里，绝大多数人都赚到钱了，少数人赔掉的金额，全然抵不上那么多人赚到的总数；到底哪一根韭菜被割了？在熊市里，绝大多数人都赔钱了，大量的人赔掉的总金额，是少数人赚到的总额的无数倍，谁在割韭菜？</p>
<p>所以，这根本就不是“零和游戏”！</p>

        <h2 id="韭菜缺的是实力">
          <a href="#韭菜缺的是实力" class="heading-link"><i class="fas fa-link"></i></a>韭菜缺的是实力</h2>
      <p>所谓“被割离场的韭菜”，本质的原因根本不是他们缺乏耐心。正如你之前看到的那样，哪怕是笨蛋，也天然在不断学习。只要是个人，在条件恰当的情况下，都有足够的耐心——这是事实。</p>
<p>缺乏耐心，其实是表象，本质是什么？本质是缺乏实力。</p>
<p>所以，想要摆脱“韭菜的宿命”，只有一个办法：提高自己的实力。</p>

        <h2 id="实力指的是什么？">
          <a href="#实力指的是什么？" class="heading-link"><i class="fas fa-link"></i></a>实力指的是什么？</h2>
      <p>在交易市场里，实力指的究竟是什么？有一个清楚的定义：</p>
<p> 长期稳定的低成本现金流。</p>
<p>控制仓位。</p>

        <h2 id="止损线如何制定才合理？">
          <a href="#止损线如何制定才合理？" class="heading-link"><i class="fas fa-link"></i></a>止损线如何制定才合理？</h2>
      <p>你可以估算一下交易标的的“日常波动幅度”。如果，X的日常波动幅度是 25%，那么，你的止损线，或者换个说法，你的“最大可忍受亏损”应该比 25% 更高，比如 40%，因为你在考虑的是风险，尤其是价格波动剧烈的交易市场里的风险，所以，“做更坏的打算”永远比“盲目乐观”更靠谱。</p>
<p>止损线到底应该定在哪里，有很多因素在起作用。甚至，连交易者的性格都是很重要的因素之一。最要命的是，你的性格确实在此时此刻决定你的行为，但回头仔细观察，你此时此刻的性格，更可能是你过去长期行为所决定的。</p>

        <h2 id="降低交易频次">
          <a href="#降低交易频次" class="heading-link"><i class="fas fa-link"></i></a>降低交易频次</h2>
      <p>交易频次越高，交易越是接近“零和游戏”。</p>
<p>韭菜想要翻身，说一千道一万，只有一条路可走：</p>
<p>降低交易频次……降低降低再降低。</p>
<p>在交易市场里：</p>
<p>越是短期的预测，越接近于抛硬币； </p>
<p>越是长期的预测，越容易接近真实的逻辑推断……</p>
<p>所以，降低交易频次的本质，是拒绝抛硬币，坚持逻辑推断。</p>

        <h2 id="提升收益风险比的方法">
          <a href="#提升收益风险比的方法" class="heading-link"><i class="fas fa-link"></i></a>提升收益风险比的方法</h2>
      <p>新手想要躲避韭菜宿命，就得天天反思，时时刻刻反思，反思之后还要再反思……</p>
<p>回报风险比=可能的回报÷可能的风险</p>
<p>看着公式，就知道，提高回报风险比的方法，无非有两个：要么加大分子，要么减小分母……</p>
<p>减小分母，可行的手段有这么几个：</p>
<p>调整止损线，降低自己的风险承担</p>
<p>降低每次的交易金额在总资金的占比</p>
<p>提高自己在场外的赚钱能力（或者募资能力）</p>

        <h2 id="孤独的交易">
          <a href="#孤独的交易" class="heading-link"><i class="fas fa-link"></i></a>孤独的交易</h2>
      <p>参考少数人的意见</p>
<p>自己做决定</p>

        <h2 id="把握周期">
          <a href="#把握周期" class="heading-link"><i class="fas fa-link"></i></a>把握周期</h2>
      <p>几乎所有的人，冲进交易市场的时候，都自然而然地犯下一个错误：一进场就买买买。</p>
<p>其深层次的原因是，这些人在冲进交易市场的时候，脑子里没有“周期”这个概念。如果交易者脑子里有这个概念，了解这个概念，擅长应用这个概念，那他就不大可能把交易当作零和游戏了，不是吗？</p>
<p>关注周期，以及多个周期背后显现出来的真正趋势，会给你一个全新且更为可靠的世界和视界。</p>
<p>如何把握周期呢？</p>
<p>仔细观察体会绝大多数交易者的情绪。牛市里，FOMO情绪达到顶峰，各种投资者开始ALL-IN的时候，上升趋势渐渐到头了；熊市里，大多数“韭菜”经过失望谩骂而后竟然平静了的时候，下跌趋势渐渐到底了……</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/09/09/android-launch-time-performance-optimization/">Android 应用启动速度优化</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-09-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-10-14</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">3k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">20分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>应用启动时间的长短，影响到用户体验。对研发人员来说，启动速度是我们的“门面”。</p>
<p>本文主要记录 Android 应用启动速度优化学习笔记。</p>

        <h2 id="应用启动类型">
          <a href="#应用启动类型" class="heading-link"><i class="fas fa-link"></i></a>应用启动类型</h2>
      <p>应用的启动流程即从点击图标到用户可操作的全部过程。启动分为三种类型：</p>
<ul>
<li><p><strong>冷启动</strong>：当启动应用时，后台没有该应用的进程，这时系统会首先会创建一个新的进程分配给该应用。</p>
</li>
<li><p><strong>热启动</strong>：当启动应用时，后台已有该应用的进程，比如按下 home 键。</p>
</li>
<li><p><strong>温启动</strong>：当启动应用时，后台已有该应用的进程，但是启动的入口 Activity 被干掉了，比如按了 back 键，应用虽然退出了，但是该应用的进程是依然会保留在后台。</p>
</li>
</ul>
<p>其中启动最慢的就是冷启动，系统和应用本身的工作都是从零开始。</p>
<p>冷启动开始时，系统有三个任务：</p>
<ul>
<li><p>启动 App</p>
</li>
<li><p>App 启动后显示一个空白的 Window</p>
</li>
<li><p>创建 App 的进程</p>
</li>
</ul>
<p>在此之后，应用进程马上会执行以下任务：</p>
<ul>
<li><p>创建 App 对象</p>
</li>
<li><p>启动 main thread</p>
</li>
<li><p>创建要启动的 Activity</p>
</li>
<li><p>加载 View</p>
</li>
<li><p>布置页面</p>
</li>
<li><p>进行第一次绘制</p>
</li>
</ul>

        <h2 id="测量时间方式">
          <a href="#测量时间方式" class="heading-link"><i class="fas fa-link"></i></a>测量时间方式</h2>
      
        <h3 id="adb-命令">
          <a href="#adb-命令" class="heading-link"><i class="fas fa-link"></i></a>adb 命令</h3>
      <p>使用 adb shell 获取应用启动时间：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -W [packageName]/[packageName.AppstartActivity]</span><br></pre></td></tr></table></div></figure>

<p>输出的结果类似于：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> adb shell am start -W com.speed.test/com.speed.test.HomeActivity</span></span><br><span class="line">Starting: Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] cmp=com.speed.test/.HomeActivity &#125;</span><br><span class="line">Status: ok</span><br><span class="line">Activity: com.speed.test/.HomeActivity</span><br><span class="line">ThisTime: 496    </span><br><span class="line">TotalTime: 496</span><br><span class="line">WaitTime: 503</span><br><span class="line">Complete</span><br></pre></td></tr></table></div></figure>

<ul>
<li>ThisTime： 代表一连串启动 Activity 的最后一个 Activity 的启动耗时。</li>
<li>TotalTime 表示新应用启动的耗时，包括新进程的启动和 Activity 的启动，但不包括前一个应用 Activity <code>pause</code> 的耗时。</li>
<li>WaitTime 返回从 <code>startActivity</code> 到应用第一帧完全显示这段时间。 就是总的耗时，包括前一个应用 Activity <code>pause</code> 的时间和新应用启动的时间。</li>
</ul>
<p>一般只需关注 TotalTime，即应用自身真正的启动耗时。</p>
<p>缺点：adb 命令无法精确查看方法具体耗费的时间，局限性比较大。</p>

        <h3 id="AOP">
          <a href="#AOP" class="heading-link"><i class="fas fa-link"></i></a>AOP</h3>
      <blockquote>
<p>AOP : Aspect Oriented Programming的缩写，意为：面向切面编程</p>
</blockquote>
<p>优点：</p>
<ol>
<li>针对同一问题的统一处理</li>
<li>无侵入添加代码</li>
</ol>
<p>Android 中使用 AspecJ 实现 AOP。详细内容看这篇文章：<a href="https://wuzhangyang.com/2020/06/03/aspectj/">Android AspectJ 学习笔记</a></p>
<p>项目根目录的 build.gradle 添加</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ...</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        ...</span><br><span class="line">        classpath &#39;com.hujiang.aspectjx:gradle-android-plugin-aspectjx:2.0.0&#39;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>app 项目的 build.gradle 新建的 module的 build.gradle 里添加</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#39;android-aspectjx&#39;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    api &#39;org.aspectj:aspectjrt:1.9.5&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>MyApplication 代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">        initBugly();</span><br><span class="line">        initBaiduMap();</span><br><span class="line">        initJPushInterface();</span><br><span class="line">        initShareSDK();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBugly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>); <span class="comment">// 模拟耗费的时间</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBaiduMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>); <span class="comment">// 模拟耗费的时间</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initJPushInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>); <span class="comment">// 模拟耗费的时间</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initShareSDK</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>); <span class="comment">// 模拟耗费的时间</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>创建切面</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerformanceAspect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;PerformanceAspect&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;call(* com.wuzy.aspectjdemo.MyApplication.**(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTime</span><span class="params">(ProceedingJoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        String methodName = joinPoint.getSignature().getName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Log.e(TAG, methodName + <span class="string">&quot;方法耗时：&quot;</span> + (System.currentTimeMillis() - startTim</span><br><span class="line">                                          e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>无需修改任何工程代码，就可以获取运行时长了</p>
<p><img src="/2019/09/09/android-launch-time-performance-optimization/performaceaspect.png" alt="performaceaspect"></p>

        <h3 id="TraceView">
          <a href="#TraceView" class="heading-link"><i class="fas fa-link"></i></a>TraceView</h3>
      <p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/profile/generate-trace-logs">TraceView</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是 Android SDK 内置的一个工具，它可以加载 trace 文件，用图形的形式展示代码的执行时间、次数及调用栈。</p>
<p>使用方式</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Debug.startMethodTracing(<span class="string">&quot;文件名&quot;</span>);</span><br><span class="line"></span><br><span class="line">Debug.stopMethodTracing();</span><br></pre></td></tr></table></div></figure>

<p>代码运行后，会在</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mnt/sdcard/Android/data/包名/files</span><br></pre></td></tr></table></div></figure>

<p>生成一个<code>.trace</code>后缀的文件，然后可以用 Android Studio 的 Profiler 添加打开它。</p>
<p><img src="/2019/09/09/android-launch-time-performance-optimization/traceview1.png" alt="traceview1"></p>
<p><strong>Wall Clock Time</strong>：表示实际经过的时间。包含线程在阻塞和等待的时间。</p>
<p><strong>Thread Time</strong>：表示实际经过的时间减去线程没有占用 CPU 资源的那部分时间。</p>
<p><strong>Flame Chart</strong>：火焰图。y 轴表示调用栈，每一层都是一个函数。调用栈越深，火焰就越高，顶部就是正在执行的函数，下方都是它的父函数。 x 轴表示抽样数，如果一个函数在 x 轴占据的宽度越宽，就表示它被抽到的次数多，即执行的时间长。注意，x 轴不代表时间，而是所有的调用栈合并后，按字母顺序排列的。</p>
<blockquote>
<p>火焰图就是看顶层的哪个函数占据的宽度最大。只要有”平顶”（plateaus），就表示该函数可能存在性能问题。</p>
</blockquote>
<p><strong>Top Down</strong>：显示一个函数调用列表，在该列表中展开函数节点会显示函数的被调用方。</p>
<p><strong>Bottom Up</strong>：显示一个函数调用列表，在该列表中展开函数节点将显示函数的调用方。</p>
<p><img src="/2019/09/09/android-launch-time-performance-optimization/top_down_and_bottom_down.png" alt="top_down_and_bottom_down"></p>
<p><strong>缺点</strong>：traceView 的原理就是抓取所有线程的所有函数里的信息，所以会导致程序变慢，工具本身带来的性能开销过大，有时无法反映真实的情况。比如一个函数本身的耗时是 1 秒，开启 TraceView 后可能会变成 5 秒。</p>

        <h3 id="Systrace-函数插桩">
          <a href="#Systrace-函数插桩" class="heading-link"><i class="fas fa-link"></i></a>Systrace + 函数插桩</h3>
      <p>Systrace 原理：在系统的一些关键链路（如SystemServcie、虚拟机、Binder驱动）插入一些信息（Label），<br>通过 Label 的开始和结束来确定某个核心过程的执行时间，然后把这些Label信息收集起来得到系统关键路径的运行时间信息，最后得到整个系统的运行性能信息。Android Framework 里面一些重要的模块都插入了 label 信息(Java 层通过 android.os.Trace 类完成，native层通过 ATrace 宏完成），用户 App 中可以添加自定义的 Lable，这样就组成了一个完成的性能分析系统。</p>
<p>具体使用教程可以看这篇文章：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27331842">手把手教你使用Systrace（一）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>Systrace 的优点：</p>
<ul>
<li>可以看大整个流程系统和应用程序的调用流程。包括系统关键线程的函数调用，渲染耗时、线程锁、GC 耗时等。</li>
<li>性能损耗可以接受。</li>
</ul>

        <h2 id="异步优化">
          <a href="#异步优化" class="heading-link"><i class="fas fa-link"></i></a>异步优化</h2>
      <p>异步优化的核心思想：子线程来分担主线程的任务，并减少运行时间。</p>

        <h3 id="FixThreadPool">
          <a href="#FixThreadPool" class="heading-link"><i class="fas fa-link"></i></a>FixThreadPool</h3>
      <p>线程池核心个数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得当前CPU的核心数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置线程池的核心线程数2-4之间,但是取决于CPU核数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = Math.max(<span class="number">2</span>, Math.min(CPU_COUNT - <span class="number">1</span>, <span class="number">4</span>));</span><br></pre></td></tr></table></div></figure>

<p>创建线程池</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建线程池</span></span><br><span class="line">ExecutorService executorService = Executors.newFixedThreadPool(CORE_POOL_SIZE);</span><br></pre></td></tr></table></div></figure>

<p>将耗时方法放在线程池中，不影响主线程页面加载。对于必须要先执行完毕才能进入页面的情况，使用 CountDownLatch 处理。</p>
<p>MyApplication#onCreate：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line"><span class="comment">//        Debug.startMethodTracing();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(CORE_POOL_SIZE);</span><br><span class="line"></span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                initBugly();</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                initBaiduMap();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                initJPushInterface();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                initShareSDK();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Debug.stopMethodTracing();</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>上面代码中：只有在 <code>initBugly</code> 执行完毕后才能跳转页面，而  <code>initBugly</code>  是可以在子线程执行，所以可以采用线程池 + CountDownLatch 实现。</p>
<p>但是，对于多个耗时任务存在依赖关联，比如必须先执行完A，根据A的返回值，再执行B，然后根据B的返回再执行C，任务串联的情况，使用线程池 + CountDownLatch  就比较麻烦。</p>

        <h3 id="启动器">
          <a href="#启动器" class="heading-link"><i class="fas fa-link"></i></a>启动器</h3>
      <p>先将任务分类：</p>
<p>![task_classification ](android-launch-time-performance-optimization/task_classification .jpg)</p>
<ul>
<li><p>head task : 我们会把一些必须先启动的task放到这里</p>
</li>
<li><p>主线程：将必须要在主线程中初始化的task放入这里</p>
</li>
<li><p>并发：将非必须在主线程中初始化的task放入这里</p>
</li>
<li><p>tail task: 一些在所有任务执行完毕之后才去初始化的放入这里，比如一些log打印等</p>
</li>
<li><p>ilde task: 通过字面就知道了将一些可以有空再初始化的task放入这里</p>
</li>
</ul>
<p>启动器的目的就是保证并发任务的执行顺序的正确性。任务执行顺序的排序采用：<strong>有向无环图的<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.jianshu.com/p/b59db381561a">拓扑排序</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></strong></p>
<p><strong>拓扑排序（Topological Sorting</strong>）是一个有向无环图（DAG, Directed Acyclic Graph）的所有顶点的线性序列。</p>
<p>且该序列必须满足下面两个条件：</p>
<ul>
<li><p>每个顶点出现且只出现一次。</p>
</li>
<li><p>若存在一条从顶点 A 到顶点 B 的路径，那么在序列中顶点 A 出现在顶点 B 的前面。</p>
</li>
</ul>
<p><strong>拓扑排序的写法思路：</strong></p>
<p>1、从 DAG 图中选择一个 没有前驱（即入度为0）的顶点并输出。</p>
<p>2、从图中删除该顶点和所有以它为起点的有向边。</p>
<p>3、重复 1 和 2 直到当前的 DAG 图为空或当前图中不存在无前驱的顶点为止。后一种情况说明有向图中必然存在环。</p>
<p><img src="/2019/09/09/android-launch-time-performance-optimization/DAG.png" alt="DAG"></p>
<p>于是，得到拓扑排序后的结果是 { 1, 2, 4, 3, 5 }。</p>
<p>启动器外部调用：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TaskDispatcher instance = TaskDispatcher.createInstance();</span><br><span class="line">       instance.addTask(<span class="keyword">new</span> InitBuglyTask()) <span class="comment">// 默认添加，并发处理</span></span><br><span class="line">               .addTask(<span class="keyword">new</span> InitBaiduMapTask())  <span class="comment">// 在这里需要先处理了另外一个耗时任务initShareSDK，才能再处理它</span></span><br><span class="line">               .addTask(<span class="keyword">new</span> InitJPushTask())  <span class="comment">// 等待主线程处理完毕，再进行执行</span></span><br><span class="line">               .start();</span><br><span class="line">       instance.await();</span><br></pre></td></tr></table></div></figure>

<p>启动器主要流程：</p>
<p><img src="/2019/09/09/android-launch-time-performance-optimization/starter_flow.jpg" alt="starter_flow"></p>
<p>具体代码：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/zywudev/PerformanceDemo">PerformanceDemo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="启动窗口优化">
          <a href="#启动窗口优化" class="heading-link"><i class="fas fa-link"></i></a>启动窗口优化</h2>
      <p>使用 Activity 的 windowBackground 属性为启动的 Activity 提供一个闪屏预览界面（layer-list），这样点击应用图标会立马显示闪屏界面。具体操作方法：</p>
<p>Layout XML：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layer-list</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:opacity</span>=<span class="string">&quot;opaque&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 背景颜色 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">&quot;@android:color/white&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 闪屏页图片 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bitmap</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:src</span>=<span class="string">&quot;@drawable/product_logo_144dp&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layer-list</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>style：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;AppTheme.Launcher&quot;</span>&gt;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowFullscreen&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowBackground&quot;</span>&gt;</span>@mipmap/layer-list<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>Manifest：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">...</span></span></span><br><span class="line"><span class="tag"><span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme.Launcher&quot;</span> /&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>Activity：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 替换回原来的主题，注意在 super.onCreate 之前调用</span></span><br><span class="line">    setTheme(R.style.Theme_MyApp);</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这种方案在通过交互体验优化了展示效果，但并没有真正的加速启动。</p>
<p>对于中低端机，总的闪屏时间会更长，建议在 Android 6.0 或者 Android 7.0 以上才启用“闪屏优化” 方案。</p>

        <h2 id="延迟初始化">
          <a href="#延迟初始化" class="heading-link"><i class="fas fa-link"></i></a>延迟初始化</h2>
      <p>首页渲染完成后，再初始化数据，也就是延迟初始化，目的就是让界面先显示出来，保证 UI 绘制的流畅性。</p>
<p>核心方法是在 Activity 的 <code>onCreate</code> 函数中加入下面的方法 ：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getWindow().getDecorView().post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        myHandler.post(mLoadingRunnable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>

<p>这里的 <code>run</code> 方法是在 Activity 的 <code>onResume</code> 之后执行的。</p>
<p>关于这种方案的机制参见 ：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.androidperformance.com/2015/11/18/Android-app-lunch-optimize-delay-load/">Android 应用启动优化:一种 DelayLoad 的实现和原理(上篇)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="建议">
          <a href="#建议" class="heading-link"><i class="fas fa-link"></i></a>建议</h2>
      <p>1、减少布局层级，建议使用约束布局 ConstraintLayout。</p>
<p>2、去掉无用代码、重复逻辑。</p>
<p>3、避免 Application 中创建线程池，尽量延迟操作。</p>
<p>4、避免启动过多工作线程。</p>
<p>5、尽量减少 GC 的次数，避免造成主线程长时间的卡顿。</p>
<p>6、一句话准则：可以异步的都异步，不可以异步的尽量延迟。</p>

        <h2 id="参考">
          <a href="#参考" class="heading-link"><i class="fas fa-link"></i></a>参考</h2>
      <p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.androidperformance.com/2015/11/18/Android-app-lunch-optimize-delay-load/">https://www.androidperformance.com/2015/11/18/Android-app-lunch-optimize-delay-load/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.jianshu.com/p/f5514b1a826c">https://www.jianshu.com/p/f5514b1a826c</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.androidperformance.com/2015/11/18/Android-app-lunch-optimize-delay-load/">https://www.androidperformance.com/2015/11/18/Android-app-lunch-optimize-delay-load/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/performance/launch-time.html">https://developer.android.google.cn/topic/performance/launch-time.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27331842">https://zhuanlan.zhihu.com/p/27331842</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://juejin.im/user/5d618e106fb9a06b084d0073/posts">https://juejin.im/user/5d618e106fb9a06b084d0073/posts</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/09/04/android-traceview/">Android 性能分析工具 TraceView</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-09-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.7k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">10分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>在做应用启动、卡顿优化时，经常会用到 Android 性能分析工具 TraceView，这里简单介绍下 TraceView 的基础使用。</p>

        <h2 id="TraceView-是什么">
          <a href="#TraceView-是什么" class="heading-link"><i class="fas fa-link"></i></a>TraceView 是什么</h2>
      <p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/profile/generate-trace-logs">TraceView</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是 Android SDK 内置的一个工具，它可以加载 <strong>trace</strong> 文件，用图形的形式展示<strong>代码的执行时间、次数及调用栈</strong>，便于我们分析。</p>

        <h2 id="生成-trace-文件">
          <a href="#生成-trace-文件" class="heading-link"><i class="fas fa-link"></i></a>生成 trace 文件</h2>
      <p>trace 文件是 log 信息文件的一种，可以通过代码，Android Studio，或者 DDMS 生成。</p>

        <h3 id="使用代码生成-trace-文件">
          <a href="#使用代码生成-trace-文件" class="heading-link"><i class="fas fa-link"></i></a>使用代码生成 trace 文件</h3>
      <p>在想要记录的地方调用 <code>Debug.startMethodTracing(&quot;sample&quot;)</code>，参数指定 <code>trace</code> 文件的名称。</p>
<p>在结束记录的地方调用 <code>Debug.stopMethodTracing()</code>，文件会被保存到 <code>/sdcard/Android/data/packageName/files</code> 文件夹下。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Debug.startMethodTracing(<span class="string">&quot;sample&quot;</span>); <span class="comment">// 开始 trace</span></span><br><span class="line">...</span><br><span class="line">Debug.stopMethodTracing();  <span class="comment">// 结束 trace</span></span><br></pre></td></tr></table></div></figure>

<p>可以使用 adb 命令导出 trace 文件，使用 Android Studio Profiler 或者 DDMS 打开。</p>

        <h3 id="使用-Android-Studio-生成-trace-文件">
          <a href="#使用-Android-Studio-生成-trace-文件" class="heading-link"><i class="fas fa-link"></i></a>使用 Android Studio 生成 trace 文件</h3>
      <p>点击工具栏中的 Profiler（Android Studio 版本是 3.4.2）, 点击 CPU 时间轴上的任意位置以打开 CPU Profiler。</p>
<p><img src="/2019/09/04/android-traceview/cpu_profiler1.png" alt="cpu_profiler1"></p>
<p>1.  <strong>事件时间轴</strong>：显示应用中的 Activity 在其生命周期内不断转换而经历各种不同状态的过程，并指示用户与设备的交互，包括屏幕旋转事件。</p>
<p>2. <strong>CPU 时间轴</strong> : 显示应用的实时 CPU 使用率以及应用当前使用的线程总数。通过沿时间线的水平轴移动鼠标，还可以检查历史 CPU 使用率数据。</p>
<p>3. <strong>线程活动时间轴</strong>：应用进程的所有线程。不同颜色对应的含义：</p>
<ul>
<li><p><strong>绿色</strong>： 表示线程处于活动状态或准备使用 CPU。 即，它正在“运行中”或处于“可运行”状态。</p>
</li>
<li><p><strong>黄色</strong>： 表示线程处于活动状态，但它正在等待一个 I/O 操作（如磁盘或网络 I/O），然后才能完成它的工作。</p>
</li>
<li><p><strong>灰色</strong>： 表示线程正在休眠且没有消耗任何 CPU 时间。 当线程需要访问尚不可用的资源时偶尔会发生这种情况。 线程进入自主休眠或内核将此线程置于休眠状态，直到所需的资源可用。</p>
</li>
</ul>
<p>要开始记录跟踪数据，点击 CPU Profiler 顶部的下拉框选择适当的记录配置：</p>
<ul>
<li><p><strong>对 Java 方法采样</strong>：在应用的 Java 代码执行期间，频繁捕获应用的调用堆栈。分析器会比较捕获的数据集，以推导与应用的 Java 代码执行有关的时间和资源使用信息。</p>
</li>
<li><p><strong>跟踪 Java 方法</strong> ：在运行时检测应用，以在每个方法调用开始和结束时记录一个时间戳。系统会收集并比较这些时间戳，以生成方法跟踪数据，包括时间信息和 CPU 使用率。</p>
</li>
<li><p><strong>对 C/C++ 函数采样</strong>：捕获应用的原生线程的采样跟踪数据。</p>
</li>
</ul>
<p><img src="/2019/09/04/android-traceview/cpu_profiler2.png" alt="cpu_profiler2"></p>
<p>选择配置后，点击 <code>Record</code> 进行跟踪，交互完成后点击 <code>Stop</code> 结束数据跟踪。分析器会分析 trace 数据，如下图所示。</p>
<p><img src="/2019/09/04/android-traceview/cpu_profiler3.png" alt="cpu_profiler3"></p>
<p>1. <strong>选择时间范围</strong>： 确定要在跟踪窗格中检查所记录时间范围的哪一部分。 当首次记录函数跟踪时，CPU Profiler 将在 CPU 时间线中自动选择完整长度。 如果想仅检查所记录时间范围一小部分的函数跟踪数据，可以点击并拖动突出显示的区域边缘以修改其长度。</p>
<p>2. <strong>时间戳</strong>： 用于表示所记录函数跟踪的开始和结束时间（相对于分析器从设备开始收集 CPU 使用率信息的时间）。 可以点击时间戳以自动选择完整记录。</p>
<p>3. <strong>跟踪窗格</strong>： 用于显示所选的时间范围和线程的函数跟踪数据。</p>
<p>4. <strong>跟踪数据窗格标签</strong>：通过Call Chart（调用图表）、Flame Chart（火焰图）、 Top Down 树或 Bottom Up 树的形式显示函数跟踪。</p>
<ul>
<li><p><strong>Call Chart</strong> : 水平轴表示函数调用（或调用方）的时间，并沿垂直轴显示其被调用者。 对系统 API 的函数调用显示为橙色，对应用自有函数的调用显示为绿色，对第三方 API（包括 Java 语言 API）的函数调用显示为蓝色。 </p>
</li>
<li><p><strong>Flame Chart</strong>: 一个倒置的调用图表，其中水平轴不再代表时间线，它表示每个函数相对的执行时间。</p>
</li>
<li><p><strong>Top Down</strong>：显示一个函数调用列表，在该列表中展开函数节点会显示函数的被调用方。</p>
</li>
<li><p><strong>Bottom Up</strong>：显示一个函数调用列表，在该列表中展开函数节点将显示函数的调用方。</p>
</li>
</ul>
<p>5. <strong>时间参考菜单</strong> ：确定如何测量每个函数调用的时间信息：</p>
<ul>
<li><p><strong>Wall clock time</strong>：实际经过的时间。</p>
</li>
<li><p><strong>Thread time</strong>：实际经过的时间减去线程没有消耗 CPU 资源的时间。</p>
</li>
</ul>

        <h3 id="使用-DDMS-生成-trace-文件">
          <a href="#使用-DDMS-生成-trace-文件" class="heading-link"><i class="fas fa-link"></i></a>使用 DDMS 生成 trace 文件</h3>
      <p>DDMS 即 Dalvik Debug Monitor Server ，是 Android 调试监控工具，它为我们提供了截图，查看 log，查看视图层级，查看内存使用等功能。</p>
<p>Android Studio 3.0 后可在 Android SDK 的 <code>tools</code> 目录，找到 <code>monitor.bat</code>，使用命令行启动它，就能打开 DDMS。 </p>
<p>DDMS 界面点击 <code>Start Method Profiling</code> 按钮，开始记录 trace，同一个按钮停止 trace。DDMS 会自动启用 TraceView 加载 trace 文件，如下图：</p>
<p><img src="/2019/09/04/android-traceview/ddms_trace.png" alt="ddms_trace"></p>
<p>图中上半部分展示了不同线程的执行时间，其中不同的颜色代表不同的方法，同一颜色越长，说明执行时间越长，空白表示这个时间段内没有执行内容。</p>
<p>下半部分展示了不同方法的执行时间信息。各个指标的含义：</p>
<ul>
<li><p>Incl Cpu Time：方法占用的 CPU 时间（包括调用子函数所消耗的时间）。</p>
</li>
<li><p>Excl Cpu Time：方法自身占用的 CPU 时间（不包括调用其他方法所消耗的时间）。</p>
</li>
<li><p>Incl Real Time：方法运行的真实时间（包括调用子函数所消耗的时间）。</p>
</li>
<li><p>Excl Real Time：方法自身运行的真实时间（不包括调用其他方法所消耗的时间）。</p>
</li>
<li><p>Calls+RecurCalls/Total：方法被调用的次数+重复调用的次数。</p>
</li>
<li><p>Cpu Time/Call：方法调用 CPU 时间与调用次数的比，相当于方法平均执行时间。</p>
</li>
<li><p>Real Time/Call：同 Cpu Time/Call 类似，只不过统计单位换成了真实时间。</p>
</li>
</ul>
<p>在分析耗时的时候一般有两种情况：</p>
<ul>
<li><p>调用次数不多。但是，本身就非常耗时。</p>
</li>
<li><p>本身不是很耗时。但是，调用非常频繁。</p>
</li>
</ul>
<p>第一种情况，可以使用 <code>Cpu Time</code> 来查看它的耗时情况。 </p>
<p>第二种情况，可以使用 <code>Calls+RecurCalls/Total</code> 来查看它的调用情况。</p>

        <h2 id="参考">
          <a href="#参考" class="heading-link"><i class="fas fa-link"></i></a>参考</h2>
      <p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/profile/cpu-profiler">https://developer.android.google.cn/studio/profile/cpu-profiler</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/u011240877/article/details/54347396">https://blog.csdn.net/u011240877/article/details/54347396</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/08/31/ten-step-learning-method/">程序员成长离不开的技能</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-08-31</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.5k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">7分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>很多人，在学生阶段习惯了被动、填鸭式学习，进入社会后，不知道如何去自我学习，严重限制了提升自己的知识和技能的机会。</p>
<p>在这个飞速发展的世界里，做一个终身学习者，自我学习的能力越强越好。</p>
<p>最近看了一本书《软技能: 代码之外的生存指南》，里面的一个主题，讲述了技术人员如何在新技术发展日新月异的世界里，如何快速高效学习技术，以下是我整理的「十步学习法」笔记，供大家参考。</p>
<p>十步学习法的基本思想就是：</p>
<p>要对自己要学的内容有个基本的了解：了解自己不知道什么就足矣。然后，利用这些信息勾勒出学习的范围，即需要学哪些内容，以及学成之后又会获得什么。依靠这些知识，你可以找出各种资源来帮助自己学习。最后，你们可以创建自己的学习计划，列出要去学习哪些相关课程，筛选学习材料，只保留能帮助自己达成目标的优质内容。</p>
<p>一旦完成这些工作，你对自己要学什么和怎样学都了然于胸，你就可以把控自己的学习计划中的每个关键点，通过「学习—实践—掌握—教授」(Learning, Doing, Learning and Teaching，LDLT) 的过程，获得对该学科的深刻理解，同时你也向着自己的目标前进。</p>
<p><img src="/2019/08/31/ten-step-learning-method/ten-step-learing-method.jpg" alt="ten-step-learing-method"></p>

        <h3 id="第-1-步-了解全局">
          <a href="#第-1-步-了解全局" class="heading-link"><i class="fas fa-link"></i></a>第 1 步 了解全局</h3>
      <p>unknown unknowns，即你根本不知道自己不知道。</p>
<p>在你打开一本新书开始阅读的时候，你对自己所不知道的一无所知。闷头往下看的话，会出现学费所需、力所不及的情况。</p>
<p>所以，在学习某一技术之前，至少要对其有所了解，对技术有一个全局的了解，这一点非常重要。</p>

        <h3 id="第-2-步-确定范围">
          <a href="#第-2-步-确定范围" class="heading-link"><i class="fas fa-link"></i></a>第 2 步 确定范围</h3>
      <p>充分利用第 1 步获得的信息，根据自己的需求，明确自己到底要学什么，确定学习范围。</p>
<p>这一步容易犯的一个错误：试图解决太大的问题而让自己陷入困境中。</p>
<p>可以将大的主题，分解小而聚焦的主题。</p>
<p>因此，学习范围务必大小适当，符合自己的学习理由，同时要保持专注。</p>

        <h3 id="第-3-步-定义目标">
          <a href="#第-3-步-定义目标" class="heading-link"><i class="fas fa-link"></i></a>第 3 步 定义目标</h3>
      <p>确定自己的学习目标，明确学习完成后应该达成的效果，根据简明清晰的目标，勾勒出勤奋学习后成功的图景。成功的标准应该是具体的，无二义性的。</p>

        <h3 id="第-4-步-寻找资源">
          <a href="#第-4-步-寻找资源" class="heading-link"><i class="fas fa-link"></i></a>第 4 步 寻找资源</h3>
      <p>尽可能的尝试多种渠道和方式收集与学习主题相关的资源。这个阶段，资源的质量无需考虑。</p>

        <h3 id="第-5-步-创建学习计划">
          <a href="#第-5-步-创建学习计划" class="heading-link"><i class="fas fa-link"></i></a>第 5 步 创建学习计划</h3>
      <p>打造自己的学习计划，一个好方法就是观察别人是如何教你感兴趣的主题的。通览你收集的全部资源，你就对自己需要哪些内容及如何组合这些内容有更清晰的认识。</p>

        <h3 id="第-6-步-筛选资源">
          <a href="#第-6-步-筛选资源" class="heading-link"><i class="fas fa-link"></i></a>第 6 步 筛选资源</h3>
      <p>对找到的资源进行筛选，挑选出最有价值的几项来帮助你实现自己的目标。</p>
<p>现在，你可以就你想要了解的一个主题，实际演练一下以上 6 个步骤了。</p>

        <h3 id="第-7-步-开始学习-浅谈辄止">
          <a href="#第-7-步-开始学习-浅谈辄止" class="heading-link"><i class="fas fa-link"></i></a>第 7 步 开始学习 浅谈辄止</h3>
      <p>大多数人，包括我自己，在学习的过程中通常会犯两类错误：第一类错误是在知之不多的情况下就盲目开始，即行动太快；第二类错误是在行动之前准备过多，即行动太晚。</p>
<p>这一步的关键在于避免过犹不及。开始学习时很容易失去自控力，深入学习计划学习中列出的所有资源。你要专注于掌握自己所需的、能在下一步动手操作的最小量的知识。</p>

        <h3 id="第-8-步-动手操作-边玩边学">
          <a href="#第-8-步-动手操作-边玩边学" class="heading-link"><i class="fas fa-link"></i></a>第 8 步 动手操作 边玩边学</h3>
      <p>在掌握操作动手最小量的知识的情况下亲自操作和亲身体验。</p>
<p>在探索和实践过程中，会产生的各种问题。这些问题会引导着你走向真正重要的方向。当回头寻找问题的答案时，不只是这些问题迎刃而解，而且你记得的东西比你学习的东西要多得多，因为你所学到的都是对你很重要的东西。</p>

        <h3 id="第-9-步-全面掌握-学以致用">
          <a href="#第-9-步-全面掌握-学以致用" class="heading-link"><i class="fas fa-link"></i></a>第 9 步 全面掌握 学以致用</h3>
      <p>好奇心是学习特别是自学的重要组成部分。</p>
<p>为了有效利用自己选择的资料，为了上一步生产的问题寻求答案（带着问题学习）。不用担心回头再去操作，付出更多，因为这不仅能够让你找到问题的答案，也能让你学习新东西。给自己足够多的时间去深入理解自己的主题，你可以阅读，可以实验，可以观察，也可以操作。试着把自己正在学习的内容与最终目标关联起来。</p>

        <h3 id="第-10-步-乐为人师-融会贯通">
          <a href="#第-10-步-乐为人师-融会贯通" class="heading-link"><i class="fas fa-link"></i></a>第 10 步 乐为人师 融会贯通</h3>
      <p>要想深入掌握一门学问，并且融会贯通，那么必须要做到能够教授给别人，在这一过程中，你要切实刨析并理解自己所学的知识，将其内化到自己的思想；同时，也要用能够让他人理解的方式精心组织这些信息。</p>
<p>在这个过程中，你会发现很多自以为明白的知识点，其实并没有你想象的那么透彻。这一过程会将那些以前自己没太明白的东西联系起来，并简化到自己的大脑中已有的信息，将它们浓缩并经常复习。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/08/09/python-save-wechat-article/">如何使用 Python 爬取微信公众号文章</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-08-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.4k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">11分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>我比较喜欢看公众号，有时遇到一个感兴趣的公众号时，都会感觉相逢恨晚，想一口气看完所有历史文章。但是微信的阅读体验挺不好的，看历史文章得一页页的往后翻，下一次再看时还得重复操作，很是麻烦。</p>
<p>于是便想着能不能把某个公众号所有的文章都保存下来，这样就很方便自己阅读历史文章了。</p>
<p>话不多说，下面我就介绍如何使用 Python 爬取微信公众号所有文章的。</p>
<p>主要有以下步骤：</p>
<p>1 使用 Fiddler 抓取公众号接口数据</p>
<p>2 使用 Python 脚本获取公众号所有历史文章数据</p>
<p>3 保存历史文章</p>

        <h2 id="Fiddler-抓包">
          <a href="#Fiddler-抓包" class="heading-link"><i class="fas fa-link"></i></a>Fiddler 抓包</h2>
      <p>Fiddler 是一款抓包工具，可以监听网络通讯数据，开发测试过程中非常有用，这里不多做介绍。没有使用过的可以查看这篇文章，很容易上手。</p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/jingjingshizhu/article/details/80566191">https://blog.csdn.net/jingjingshizhu/article/details/80566191</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>接下来，使用微信桌面客户端，打开某个公众号的历史文章，这里以我的公众号举例，如下图。</p>
<p><img src="/2019/08/09/python-save-wechat-article/wechat_article.png" alt="wechat_article"></p>
<p>如果你的 fiddler 配置好了的话，能够看到如下图的数据。</p>
<p><img src="/2019/08/09/python-save-wechat-article/fiddler_wechat.png" alt="fiddler_wechat"></p>
<p>图中包含抓取的 url、一些重要的参数和我们想要的数据。</p>
<p>这些参数中，<code>offset</code> 控制着翻页，其他参数在每一页中都是固定不变的。</p>
<p>接口返回的数据结构如下图，其中 <code>can_msg_continue</code> 字段控制着能否翻页，1 表示还有下一页，0 表示没有已经是最后一页了。 <code>next_offset</code> 字段就是下一次请求的 <code>offset</code> 参数。</p>
<p><img src="/2019/08/09/python-save-wechat-article/wechat_json.png" alt="wechat_json"></p>

        <h2 id="构造请求，获取数据">
          <a href="#构造请求，获取数据" class="heading-link"><i class="fas fa-link"></i></a>构造请求，获取数据</h2>
      <p>接下来我们的目标就是根据 url 和一些参数，构建请求，获取标题、文章 url 和日期等数据，保存数据。</p>
<p>保存数据一种是使用 pdfkit 将 文章 url 保存为 pdf 文件；另一种是先保存 html 文件，然后将 html 制作成 chm 文件。</p>
<p>1 将 文章 url 保存为 pdf 文件，关键代码如下：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">index, biz, uin, key</span>):</span></span><br><span class="line">    <span class="comment"># url前缀</span></span><br><span class="line">    url = <span class="string">&quot;https://mp.weixin.qq.com/mp/profile_ext&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 请求头</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 &quot;</span></span><br><span class="line">                      <span class="string">&quot;Safari/537.36 MicroMessenger/6.5.2.501 NetType/WIFI WindowsWechat QBCore/3.43.901.400 &quot;</span></span><br><span class="line">                      <span class="string">&quot;QQBrowser/9.0.2524.400&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proxies = &#123;</span><br><span class="line">        <span class="string">&#x27;https&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&#x27;http&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重要参数</span></span><br><span class="line">    param = &#123;</span><br><span class="line">        <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;getmsg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;__biz&#x27;</span>: biz,</span><br><span class="line">        <span class="string">&#x27;f&#x27;</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;offset&#x27;</span>: index * <span class="number">10</span>,</span><br><span class="line">        <span class="string">&#x27;count&#x27;</span>: <span class="string">&#x27;10&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;is_ok&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;scene&#x27;</span>: <span class="string">&#x27;124&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uin&#x27;</span>: uin,</span><br><span class="line">        <span class="string">&#x27;key&#x27;</span>: key,</span><br><span class="line">        <span class="string">&#x27;wxtoken&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;x5&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送请求，获取响应</span></span><br><span class="line">    response = requests.get(url, headers=headers, params=param, proxies=proxies)</span><br><span class="line">    response_dict = response.json()</span><br><span class="line"></span><br><span class="line">    print(response_dict)</span><br><span class="line"></span><br><span class="line">    next_offset = response_dict[<span class="string">&#x27;next_offset&#x27;</span>]</span><br><span class="line">    can_msg_continue = response_dict[<span class="string">&#x27;can_msg_continue&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    general_msg_list = response_dict[<span class="string">&#x27;general_msg_list&#x27;</span>]</span><br><span class="line">    data_list = json.loads(general_msg_list)[<span class="string">&#x27;list&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(data_list)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> data_list:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 文章发布时间</span></span><br><span class="line">            datetime = data[<span class="string">&#x27;comm_msg_info&#x27;</span>][<span class="string">&#x27;datetime&#x27;</span>]</span><br><span class="line">            date = time.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>, time.localtime(datetime))</span><br><span class="line"></span><br><span class="line">            msg_info = data[<span class="string">&#x27;app_msg_ext_info&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 文章标题</span></span><br><span class="line">            title = msg_info[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 文章链接</span></span><br><span class="line">            url = msg_info[<span class="string">&#x27;content_url&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 自己定义存储路径（绝对路径）</span></span><br><span class="line">            pdfkit.from_url(url, <span class="string">&#x27;C:/Users/admin/Desktop/wechat_to_pdf/&#x27;</span> + date + title + <span class="string">&#x27;.pdf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            print(title + date + <span class="string">&#x27;成功&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">&quot;不是图文消息&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> can_msg_continue == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;爬取完毕&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>

<p>2 保存 html 文件，关键代码如下</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">index, biz, uin, key</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># url前缀</span></span><br><span class="line">    url = <span class="string">&quot;https://mp.weixin.qq.com/mp/profile_ext&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 请求头</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 &quot;</span></span><br><span class="line">                      <span class="string">&quot;Safari/537.36 MicroMessenger/6.5.2.501 NetType/WIFI WindowsWechat QBCore/3.43.901.400 &quot;</span></span><br><span class="line">                      <span class="string">&quot;QQBrowser/9.0.2524.400&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proxies = &#123;</span><br><span class="line">        <span class="string">&#x27;https&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&#x27;http&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重要参数</span></span><br><span class="line">    param = &#123;</span><br><span class="line">        <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;getmsg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;__biz&#x27;</span>: biz,</span><br><span class="line">        <span class="string">&#x27;f&#x27;</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;offset&#x27;</span>: index * <span class="number">10</span>,</span><br><span class="line">        <span class="string">&#x27;count&#x27;</span>: <span class="string">&#x27;10&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;is_ok&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;scene&#x27;</span>: <span class="string">&#x27;124&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uin&#x27;</span>: uin,</span><br><span class="line">        <span class="string">&#x27;key&#x27;</span>: key,</span><br><span class="line">        <span class="string">&#x27;wxtoken&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;x5&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送请求，获取响应</span></span><br><span class="line">    reponse = requests.get(url, headers=headers, params=param, proxies=proxies)</span><br><span class="line">    reponse_dict = reponse.json()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(reponse_dict)</span></span><br><span class="line">    next_offset = reponse_dict[<span class="string">&#x27;next_offset&#x27;</span>]</span><br><span class="line">    can_msg_continue = reponse_dict[<span class="string">&#x27;can_msg_continue&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    general_msg_list = reponse_dict[<span class="string">&#x27;general_msg_list&#x27;</span>]</span><br><span class="line">    data_list = json.loads(general_msg_list)[<span class="string">&#x27;list&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    print(data_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> data_list:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            datetime = data[<span class="string">&#x27;comm_msg_info&#x27;</span>][<span class="string">&#x27;datetime&#x27;</span>]</span><br><span class="line">            date = time.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>, time.localtime(datetime))</span><br><span class="line"></span><br><span class="line">            msg_info = data[<span class="string">&#x27;app_msg_ext_info&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 标题</span></span><br><span class="line">            title = msg_info[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 内容的url</span></span><br><span class="line">            url = msg_info[<span class="string">&#x27;content_url&#x27;</span>].replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;http&quot;</span>, <span class="string">&quot;https&quot;</span>)</span><br><span class="line">            url = html.unescape(url)</span><br><span class="line">            print(url)</span><br><span class="line"></span><br><span class="line">            res = requests.get(url, headers=headers, proxies=proxies)</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">&#x27;C:/Users/admin/Desktop/test/&#x27;</span> + title + <span class="string">&#x27;.html&#x27;</span>, <span class="string">&#x27;wb+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(res.content)</span><br><span class="line"></span><br><span class="line">            print(title + date + <span class="string">&#x27;成功&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">&quot;不是图文消息&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> can_msg_continue == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;全部获取完毕&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="保存文章">
          <a href="#保存文章" class="heading-link"><i class="fas fa-link"></i></a>保存文章</h2>
      <p><strong>保存为 pdf 文件</strong>，用到了 python 的第三方库 pdfkit 和 wkhtmltopdf。</p>
<p>安装 pdfkit：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pdfkit</span><br></pre></td></tr></table></div></figure>

<p>安装 wkhtmltopdf：</p>
<p>下载地址：</p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://wkhtmltopdf.org/downloads.html">https://wkhtmltopdf.org/downloads.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>安装后将 wkhtmltopdf 目录下的 bin 添加到环境变量中。</p>
<p><strong>保存为 chm 文件</strong>，可以下载 Easy CHM ，使用这个软件可以将 html 制作成 chm，使用教程网上比较多。</p>
<p>下载地址：</p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://www.etextwizard.com/cn/easychm.html">http://www.etextwizard.com/cn/easychm.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>效果图：</p>
<p><img src="/2019/08/09/python-save-wechat-article/chm.png" alt="chm"></p>
<p><strong>pdf 和 chm 对比</strong>：</p>
<p>pdf 支持多终端，阅读体验好，但是有个大坑，就是微信文章保存的 pdf 没有图片，很影响阅读体验，暂未找到解决办法。</p>
<p>chm 的好处是可以建立索引，查看文章方便。一个公众号制作成一个 chm 文件，管理方便。不会出现图片不显示问题。</p>
<p>所以推荐将爬取到的公众号文章保存为 chm 文件，方便阅读。</p>
<p>需要完整代码和文中相关软件的朋友，可以关注公众号「贾小昆」，后台回复关键词 ”<strong>公众号文章</strong>“ 获取。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/07/28/yuv-format-explaination/">YUV 格式详解</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-07-28</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.9k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">12分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>一般的视频采集芯片输出的码流一般都是 YUV 格式数据流，后续视频处理也是对 YUV 数据流进行编码和解析。所以，了解 YUV 数据流对做视频领域的人而言，至关重要。</p>
<p>在介绍 YUV 格式之前，首先介绍一下我们熟悉的 RGB 格式。</p>

        <h2 id="RGB">
          <a href="#RGB" class="heading-link"><i class="fas fa-link"></i></a>RGB</h2>
      <p>RGB 分别表示红（R）、绿（G）、蓝（B），也就是三原色，将它们以不同的比例叠加，可以产生不同的颜色。</p>
<p>比如一张 1920 * 1280 的图片，代表着有 1920 * 1280 个像素点。如果采用 RGB 编码方式，每个像素点都有红、绿、蓝三个原色，其中每个原色占用 8bit，每个像素占用 24bit，也就是 3 个字节。</p>
<p>那么，一张 1920 * 1280 大小的图片，就占用 1920 * 1280 * 3 / 1024 / 1024 = 7.03MB 存储空间。</p>

        <h2 id="YUV">
          <a href="#YUV" class="heading-link"><i class="fas fa-link"></i></a>YUV</h2>
      <p>YUV 编码采用了明亮度和色度表示每个像素的颜色。</p>
<p>其中 Y 表示明亮度（Luminance、Luma），也就是灰阶值。</p>
<p>U、V 表示色度（Chrominance 或 Chroma），描述的是色调和饱和度。</p>
<p>YCbCr 其实是 YUV 经过缩放和偏移的翻版。其中 Y 与 YUV 中的 Y 含义一致,Cb,Cr 同样都指色彩，只是在表示方法上不同而已。YCbCr 其中 Y 是指亮度分量，Cb 指蓝色色度分量，而 Cr 指红色色度分量。</p>
<p><img src="/2019/07/28/yuv-format-explaination/yuv-image.png" alt="yuv-image"></p>

        <h2 id="YUV-优点">
          <a href="#YUV-优点" class="heading-link"><i class="fas fa-link"></i></a>YUV 优点</h2>
      <p>对于 YUV 所表示的图像，Y 和 UV 分量是分离的。如果只有 Y 分量而没有 UV 分离，那么图像表示的就是黑白图像。彩色电视机采用的就是 YUV 图像，<strong>解决与和黑白电视机的兼容问题，使黑白电视机也能接受彩色电视信号</strong>。</p>
<p>人眼对色度的敏感程度低于对亮度的敏感程度。主要原因是视网膜杆细胞多于视网膜锥细胞，其中视网膜杆细胞的作用就是识别亮度，视网膜锥细胞的作用就是识别色度。所以，眼睛对于亮度的分辨要比对颜色的分辨精细一些。</p>
<p>利用这个原理，可以把色度信息减少一点，人眼也无法查觉这一点。</p>
<p>所以，并不是每个像素点都需要包含了 Y、U、V 三个分量，根据不同的采样格式，可以每个 Y 分量都对应自己的 UV 分量，也可以几个 Y 分量共用 UV 分量。<strong>相比 RGB，能够节约不少存储空间。</strong></p>

        <h2 id="YUV-采样格式">
          <a href="#YUV-采样格式" class="heading-link"><i class="fas fa-link"></i></a>YUV 采样格式</h2>
      <p>YUV 图像的主流采样方式有如下三种：</p>
<ul>
<li>YUV 4:4:4 采样</li>
<li>YUV 4:2:2 采样</li>
<li>YUV 4:2:0 采样</li>
</ul>

        <h3 id="YUV-4-4-4">
          <a href="#YUV-4-4-4" class="heading-link"><i class="fas fa-link"></i></a>YUV 4:4:4</h3>
      <p>YUV 4:4:4 表示 Y、U、V 三分量采样率相同，即每个像素的三分量信息完整，都是 8bit，每个像素占用 3 个字节。</p>
<p>如下图所示：</p>
<p><img src="/2019/07/28/yuv-format-explaination/yuv444.gif" alt="yuv444"></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">四个像素为： [Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]</span><br><span class="line">采样的码流为： Y0 U0 V0 Y1 U1 V1 Y2 U2 V2 Y3 U3 V3</span><br><span class="line">映射出的像素点为：[Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]</span><br></pre></td></tr></table></div></figure>

<p>可以看到这种采样方式与 RGB 图像大小是一样的。</p>

        <h3 id="YUV-4-2-2">
          <a href="#YUV-4-2-2" class="heading-link"><i class="fas fa-link"></i></a>YUV 4:2:2</h3>
      <p>YUV 4:2:2 表示 UV 分量的采样率是 Y 分量的一半。</p>
<p>如下图所示：</p>
<p><img src="/2019/07/28/yuv-format-explaination/yuv422.gif" alt="yuv422"></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">四个像素为： [Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]</span><br><span class="line">采样的码流为： Y0 U0 Y1 V1 Y2 U2 Y3 U3</span><br><span class="line">映射出的像素点为：[Y0 U0 V1]、[Y1 U0 V1]、[Y2 U2 V3]、[Y3 U2 V3]</span><br></pre></td></tr></table></div></figure>

<p>其中，每采样一个像素点，都会采样其 Y 分量，而 U、V 分量都会间隔采集一个，映射为像素点时，第一个像素点和第二个像素点共用了 U0、V1 分量，以此类推。从而节省了图像空间。</p>
<p>比如一张 1920 * 1280 大小的图片，采用 YUV 4:2:2 采样时的大小为：</p>
<blockquote>
<p>(1920 * 1280 * 8 + 1920 * 1280 * 0.5 * 8 * 2 ) / 8 / 1024 / 1024 = 4.68M</p>
</blockquote>
<p>可以看出，比 RGB 节省了三分之一的存储空间。</p>

        <h3 id="YUV-4-2-0">
          <a href="#YUV-4-2-0" class="heading-link"><i class="fas fa-link"></i></a>YUV 4:2:0</h3>
      <p>YUV 4:2:0 并不意味着不采样 V 分量。它指的是对每条扫描线来说，只有一种色度分量以 2:1 的采样率存储，相邻的扫描行存储不同的色度分量。也就是说，如果第一行是 4:2:0，下一行就是 4:0:2，在下一行就是 4:2:0，以此类推。</p>
<p>如下图所示：</p>
<p><img src="/2019/07/28/yuv-format-explaination/yuv420.gif" alt="yuv420"></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">图像像素为：</span><br><span class="line">[Y0 U0 V0]、[Y1 U1 V1]、 [Y2 U2 V2]、 [Y3 U3 V3]</span><br><span class="line">[Y5 U5 V5]、[Y6 U6 V6]、 [Y7 U7 V7] 、[Y8 U8 V8]</span><br><span class="line"></span><br><span class="line">采样的码流为：</span><br><span class="line">Y0 U0 Y1 Y2 U2 Y3 </span><br><span class="line">Y5 V5 Y6 Y7 V7 Y8</span><br><span class="line"></span><br><span class="line">映射出的像素点为：</span><br><span class="line">[Y0 U0 V5]、[Y1 U0 V5]、[Y2 U2 V7]、[Y3 U2 V7]</span><br><span class="line">[Y5 U0 V5]、[Y6 U0 V5]、[Y7 U2 V7]、[Y8 U2 V7]</span><br></pre></td></tr></table></div></figure>

<p>其中，每采样一个像素点，都会采样 Y 分量，而 U、V 分量都会隔行按照 2:1 进行采样。</p>
<p>一张 1920 * 1280 大小的图片，采用 YUV 4:2:0 采样时的大小为：</p>
<blockquote>
<p>(1920 * 1280 * 8 + 1920 * 1280 * 0.25 * 8  * 2 ) / 8 / 1024 / 1024 = 3.51M</p>
</blockquote>
<p>相比 RGB，节省了一半的存储空间。</p>

        <h2 id="YUV-存储格式">
          <a href="#YUV-存储格式" class="heading-link"><i class="fas fa-link"></i></a>YUV 存储格式</h2>
      <p>YUV 数据有两种存储格式：平面格式（planar format）和打包格式（packed format）。</p>
<ul>
<li>planar format：先连续存储所有像素点的 Y，紧接着存储所有像素点的 U，随后是所有像素点的 V。</li>
<li>packed format：每个像素点的 Y、U、V 是连续交错存储的。</li>
</ul>
<p>因为不同的采样方式和存储格式，就会产生多种 YUV 存储方式，这里只介绍基于 YUV422 和  YUV420 的存储方式。</p>

        <h3 id="YUYV">
          <a href="#YUYV" class="heading-link"><i class="fas fa-link"></i></a>YUYV</h3>
      <p>YUYV 格式属于 YUV422，采用打包格式进行存储，Y 和 UV 分量按照 2:1 比例采样，每个像素都采集 Y 分量，每隔一个像素采集它的 UV 分量。</p>
<blockquote>
<p>Y0 U0 Y1 V0 Y2 U2 Y3 V2</p>
</blockquote>
<p>Y0 和 Y1 共用 U0 V0 分量，Y2 和 Y3 共用 U2 V2 分量。</p>

        <h3 id="UYVY">
          <a href="#UYVY" class="heading-link"><i class="fas fa-link"></i></a>UYVY</h3>
      <p>UYVY 也是 YUV422 采样的存储格式中的一种，只不过与 YUYV 排列顺序相反。</p>
<blockquote>
<p>U0 Y0 V0 Y1 U2 Y2 V2 Y3</p>
</blockquote>

        <h3 id="YUV-422P">
          <a href="#YUV-422P" class="heading-link"><i class="fas fa-link"></i></a>YUV 422P</h3>
      <p>YUV422P 属于 YUV422 的一种，它是一种 planer 模式，即 Y、U、V 分别存储。</p>

        <h3 id="YUV420P-和-YUV420SP">
          <a href="#YUV420P-和-YUV420SP" class="heading-link"><i class="fas fa-link"></i></a>YUV420P 和 YUV420SP</h3>
      <p>YUV420P 是基于 planar 平面模式进行存储，先存储所有的 Y 分量，然后存储所有的 U 分量或者 V 分量。</p>
<p><img src="/2019/07/28/yuv-format-explaination/yuv420p.png" alt="yuv420p"></p>
<p>同样，YUV420SP 也是基于 planar 平面模式存储，与 YUV420P 的区别在于它的 U、V 分量是按照 UV 或者 VU 交替顺序进行存储。</p>
<p><img src="/2019/07/28/yuv-format-explaination/yuv420sp.png" alt="yuv420sp"></p>

        <h3 id="YU12-和-YU21">
          <a href="#YU12-和-YU21" class="heading-link"><i class="fas fa-link"></i></a>YU12 和 YU21</h3>
      <p>YU12 和 YV12 格式都属于 YUV 420P 类型，即先存储 Y 分量，再存储 U、V 分量，区别在于：YU12 是先 Y 再 U 后 V，而 YV12 是先 Y 再 V 后 U 。</p>

        <h3 id="NV21-和-NV21">
          <a href="#NV21-和-NV21" class="heading-link"><i class="fas fa-link"></i></a>NV21 和 NV21</h3>
      <p>NV12 和 NV21 格式都属于 YUV420SP 类型。它也是先存储了 Y 分量，但接下来并不是再存储所有的 U 或者 V 分量，而是把 UV 分量交替连续存储。</p>
<p>NV12 是 IOS 中有的模式，它的存储顺序是先存 Y 分量，再 UV 进行交替存储。</p>
<p>NV21 是 安卓 中有的模式，它的存储顺序是先存 Y 分量，在 VU 交替存储。</p>

        <h2 id="YUV-与-RGB-转换">
          <a href="#YUV-与-RGB-转换" class="heading-link"><i class="fas fa-link"></i></a>YUV 与 RGB 转换</h2>
      <p>YUV 与 RGB 之间的转换，就是将 图像所有像素点的 R、G、B 分量和 Y、U、 分量相互转换。</p>
<p>有如下转换公式：</p>
<p><img src="/2019/07/28/yuv-format-explaination/yuv2rgb.png" alt="yuv2rgb"></p>
<p><img src="/2019/07/28/yuv-format-explaination/rgb2yuv.png" alt="rgb2yuv"></p>

        <h2 id="参考">
          <a href="#参考" class="heading-link"><i class="fas fa-link"></i></a>参考</h2>
      <p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/YUV">https://zh.wikipedia.org/wiki/YUV</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://glumes.com/post/ffmpeg/understand-yuv-format/">https://glumes.com/post/ffmpeg/understand-yuv-format/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/MrJonathan/article/details/17718761">https://blog.csdn.net/MrJonathan/article/details/17718761</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://www.fourcc.org/pixel-format/yuv-i420/">http://www.fourcc.org/pixel-format/yuv-i420/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://msdn.microsoft.com/zh-cn/library/ms867704.aspx">https://msdn.microsoft.com/zh-cn/library/ms867704.aspx</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2019/06/28/kotlin-koans-notes/">Kotlin Koans 学习笔记</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-06-28</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-09-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">4.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">42分</span></span></div></header><div class="post-body"><div class="post-excerpt"><blockquote>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/Kotlin/kotlin-koans">Kotlin Koans</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是 Kotlin 官方推出的一系列 Kotlin 语法练习。</p>
<p>一共分为 6 个模块，每个模块若干任务，每个任务都有一系列单元测试，目标就是编码通过单元测试。</p>
<p>本文是在学习 Kotlin Koans 过程中将相关语法点做一个简单的记录。</p>
</blockquote>

        <h1 id="Introduction">
          <a href="#Introduction" class="heading-link"><i class="fas fa-link"></i></a>Introduction</h1>
      
        <h2 id="Hello-World">
          <a href="#Hello-World" class="heading-link"><i class="fas fa-link"></i></a>Hello_World</h2>
      <p>和大多数语言一样，第一个任务的名称就是 Hello World。这个任务很简单，就是要求 task0 函数返回一个字符串<code>ok</code>。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task0</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>Kotlin 中函数使用关键字<code>fun</code>声明，返回类型在函数名称的后面，中间以<code>:</code>分开。</p>

        <h2 id="Java-to-Kotlin-Convert">
          <a href="#Java-to-Kotlin-Convert" class="heading-link"><i class="fas fa-link"></i></a>Java to Kotlin Convert</h2>
      <p>将 Java 代码转化为 Kotlin 代码。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java</span></span><br><span class="line"><span class="keyword">public</span> String task1(Collection&lt;Integer&gt; collection) &#123;</span><br><span class="line">    StringBuilder sb = new StringBuilder();</span><br><span class="line">    sb.append(<span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line">    Iterator&lt;Integer&gt; iterator = collection.iterator();</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        Integer element = iterator.next();</span><br><span class="line">        sb.append(element);</span><br><span class="line">        <span class="keyword">if</span> (iterator.hasNext()) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sb.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//kotlin</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task1</span><span class="params">(collection: <span class="type">Collection</span>&lt;<span class="type">Int</span>&gt;)</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">val</span> sb = StringBuilder()</span><br><span class="line">    sb.append(<span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> iterator = collection.iterator()</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">val</span> element = iterator.next()</span><br><span class="line">        sb.append(element)</span><br><span class="line">        <span class="keyword">if</span> (iterator.hasNext()) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sb.append(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> sb.toString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Named-Arguments">
          <a href="#Named-Arguments" class="heading-link"><i class="fas fa-link"></i></a>Named Arguments</h2>
      <p>使用 kotlin 提供的 <code>joinToString()</code> 完成任务1，只指定 <code>joinToString()</code> 的参数。</p>
<p>kotlin 中函数参数可以有默认值，当省略相应的参数时使用默认值。与其他语言相比，这可以减少重载数量：</p>
<p>默认值通过类型后面的<code>=</code>及给出的值定义。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">read</span><span class="params">(b: <span class="type">Array</span>&lt;<span class="type">Byte</span>&gt;, off: <span class="type">Int</span> = <span class="number">0</span>, len: <span class="type">Int</span> = b.size)</span></span> &#123; …… &#125;</span><br></pre></td></tr></table></div></figure>

<p>重写一个有默认参数的函数时，我们不允许重新指定默认参数的值。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">(i: <span class="type">Int</span> = <span class="number">10</span>)</span></span> &#123; …… &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> : <span class="type">A</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">(i: <span class="type">Int</span>)</span></span> &#123; …… &#125;  <span class="comment">// 不能有默认值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以在调用函数时使用命名的函数参数。当一个函数有大量的参数或默认参数时这会非常方便。</p>
<p>回到任务本身，先看一下函数 <code>joinToString</code>：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Iterable<span class="type">&lt;T&gt;</span>.<span class="title">joinToString</span><span class="params">(separator: <span class="type">CharSequence</span> = <span class="string">&quot;, &quot;</span>, prefix: <span class="type">CharSequence</span> = <span class="string">&quot;&quot;</span>, postfix: <span class="type">CharSequence</span> = <span class="string">&quot;&quot;</span>, limit: <span class="type">Int</span> = <span class="number">-1</span>, truncated: <span class="type">CharSequence</span> = <span class="string">&quot;...&quot;</span>, transform: ((<span class="type">T</span>) -&gt; <span class="type">CharSequence</span>)? = <span class="literal">null</span>)</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> joinTo(StringBuilder(), separator, prefix, postfix, limit, truncated, transform).toString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>该函数对分隔符，前缀，后缀等其他参数都指定了默认值，我们只需要重新指定前缀、后缀两个参数。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task2</span><span class="params">(collection: <span class="type">Collection</span>&lt;<span class="type">Int</span>&gt;)</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> collection.joinToString(postfix = <span class="string">&quot;&#125;&quot;</span>,prefix = <span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Default-Arguments">
          <a href="#Default-Arguments" class="heading-link"><i class="fas fa-link"></i></a>Default Arguments</h2>
      <p>使用参数默认值，修改<code>foo</code>函数，实现 Java 中需要重载才能实现的功能。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">(name: <span class="type">String</span>, number: <span class="type">Number</span> = <span class="number">42</span>, toUpperCase: <span class="type">Boolean</span> = <span class="literal">false</span>)</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">if</span> (toUpperCase) name.toUpperCase() <span class="keyword">else</span> name) + number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task3</span><span class="params">()</span></span>: String &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (foo(<span class="string">&quot;a&quot;</span>) +</span><br><span class="line">            foo(<span class="string">&quot;b&quot;</span>, number = <span class="number">1</span>) +</span><br><span class="line">            foo(<span class="string">&quot;c&quot;</span>, toUpperCase = <span class="literal">true</span>) +</span><br><span class="line">            foo(name = <span class="string">&quot;d&quot;</span>, number = <span class="number">2</span>, toUpperCase = <span class="literal">true</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>非常简洁。这里还可以看出 <code>if</code> 是一个表达式，即它会返回一个值。 因此就不需要三元运算符（条件 ? 然后 : 否则）</p>

        <h2 id="Lambdas">
          <a href="#Lambdas" class="heading-link"><i class="fas fa-link"></i></a>Lambdas</h2>
      <p>使用 Lambda 重写 Java 代码：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java</span></span><br><span class="line"><span class="keyword">public</span> boolean task4(Collection&lt;Integer&gt; collection) &#123;</span><br><span class="line">     <span class="keyword">return</span> Iterables.any(collection, new Predicate&lt;Integer&gt;() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> boolean apply(Integer element) &#123;</span><br><span class="line">             <span class="keyword">return</span> element % <span class="number">2</span> == <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kotlin</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task4</span><span class="params">(collection: <span class="type">Collection</span>&lt;<span class="type">Int</span>&gt;)</span></span>: <span class="built_in">Boolean</span> = collection.any &#123; x -&gt; x % <span class="number">2</span> == <span class="number">0</span> &#125;</span><br></pre></td></tr></table></div></figure>

<p>Lambda 表达式的特征：</p>
<ul>
<li>Lambdas 表达式是花括号括起来的代码块。</li>
<li>如果一个 lambda 表达式有参数，前面是参数，后跟<code>-&gt;</code> 。</li>
<li>函数体写在<code>-&gt;</code>符号后面。</li>
</ul>

        <h2 id="String-Templates">
          <a href="#String-Templates" class="heading-link"><i class="fas fa-link"></i></a>String Templates</h2>
      <p>生成一个正则表达式，可以匹配<code>13 JUN 1992</code> 这样格式的字符串。</p>
<p>kotlin 中支持两种字符串格式：</p>
<p>一种是一对<code>&quot;</code>包起来的字符串，支持转义字符。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> s = <span class="string">&quot;Hello, world!\n&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>一种是一对<code> &quot;&quot;&quot;</code>包起来的字符串，不需要用<code>\</code>来转义，可以直接使用各种符号，包括换行符。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val text &#x3D; &quot;&quot;&quot;</span><br><span class="line">    for (c in &quot;foo&quot;)</span><br><span class="line">        print(c)</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></div></figure>

<p>字符串字面值可以包含<em>模板表达式</em> ，即一些小段代码，会求值并把结果合并到字符串中。 模板表达式以美元符（<code>$</code>）开头，由一个简单的名字构成:</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> i = <span class="number">10</span></span><br><span class="line">println(<span class="string">&quot;i = <span class="variable">$i</span>&quot;</span>) <span class="comment">// 输出“i = 10”</span></span><br></pre></td></tr></table></div></figure>

<p>回到任务，修改模板字符串，使其可以匹配测试中的日期格式。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> month = <span class="string">&quot;(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task5</span><span class="params">()</span></span>: String = <span class="string">&quot;&quot;&quot;\d&#123;2&#125;\ <span class="variable">$month</span>\ \d&#123;4&#125;&quot;&quot;&quot;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="Data-Classes">
          <a href="#Data-Classes" class="heading-link"><i class="fas fa-link"></i></a>Data Classes</h2>
      <p>将 Java 中的数据实体类转化成 Kotlin。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java</span></span><br><span class="line"><span class="keyword">public</span> static <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> int age;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> Person(String name, int age) &#123;</span><br><span class="line">         <span class="keyword">this</span>.name = name;</span><br><span class="line">         <span class="keyword">this</span>.age = age;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> String getName() &#123;</span><br><span class="line">         <span class="keyword">return</span> name;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> int getAge() &#123;</span><br><span class="line">         <span class="keyword">return</span> age;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kotlin</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>(<span class="keyword">val</span> name: String, <span class="keyword">val</span> age: <span class="built_in">Int</span>)</span><br></pre></td></tr></table></div></figure>

<p>kotlin 中使用<code>data</code>标记的类，编译器会自动根据主构造函数中定义的属性生成下面这些成员函数：</p>
<ul>
<li><code>equals()</code>/<code>hashCode()</code> 对；</li>
<li><code>toString()</code> 格式是 <code>&quot;Person(name=John, age=42)&quot;</code>；</li>
<li><code>componentN()</code>按声明顺序对应于所有属性；</li>
<li><code>copy()</code> 函数。</li>
</ul>

        <h2 id="Nullable-Type">
          <a href="#Nullable-Type" class="heading-link"><i class="fas fa-link"></i></a>Nullable Type</h2>
      <p>将 Java 版本的 <code>sendMessageToClient</code> 方法使用 kotlin 改写，只能使用 <code>if</code> 表达式。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageToClient</span><span class="params">(<span class="meta">@Nullable</span> Client client, <span class="meta">@Nullable</span> String message, <span class="meta">@NotNull</span> Mailer mailer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (client == <span class="keyword">null</span> || message == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    PersonalInfo personalInfo = client.getPersonalInfo();</span><br><span class="line">    <span class="keyword">if</span> (personalInfo == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    String email = personalInfo.getEmail();</span><br><span class="line">    <span class="keyword">if</span> (email == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    mailer.sendMessage(email, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>kotlin 中，如果一个变量可能为空，在定义的时候需要在类型后面加上 <code>?</code> </p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> a: <span class="built_in">Int</span>? = <span class="literal">null</span></span><br></pre></td></tr></table></div></figure>

<p>对于可能为空的变量，如果必须在其值不为 null 时才进行后续操作，可以使用 <code>?.</code>操作符进行保护。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a?.toLong()</span><br></pre></td></tr></table></div></figure>

<p>如果变量为空，想要提供一个替代值，可以使用 <code>?:</code>：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> b = a?.toLong() ?: <span class="number">0L</span></span><br></pre></td></tr></table></div></figure>

<p>回到任务本身。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sendMessageToClient</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        client: <span class="type">Client</span>?, message: <span class="type">String</span>?, mailer: <span class="type">Mailer</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> email = client?.personalInfo?.email</span><br><span class="line">    <span class="keyword">if</span> (email != <span class="literal">null</span> &amp;&amp; message != <span class="literal">null</span>) &#123;</span><br><span class="line">        mailer.sendMessage(email,message)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Smart-Casts">
          <a href="#Smart-Casts" class="heading-link"><i class="fas fa-link"></i></a>Smart Casts</h2>
      <p>使用 kotlin 中 的Smart Cast 和 when表达式重新实现 Java 代码中的 <code>eval()</code> 函数。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">eval</span><span class="params">(Expr expr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (expr <span class="keyword">instanceof</span> Num) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Num) expr).getValue();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (expr <span class="keyword">instanceof</span> Sum) &#123;</span><br><span class="line">        Sum sum = (Sum) expr;</span><br><span class="line">        <span class="keyword">return</span> eval(sum.getLeft()) + eval(sum.getRight());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unknown expression&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>kotlin 中使用<code>when</code>代替了<code>switch</code>，功能更强大。</p>
<p>在 <code>when</code> 中，我们使用 <code>-&gt;</code> 表示执行某一分支后的操作，<code>-&gt;</code> 之前是条件，可以是任何表达式。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">when</span> (x) &#123;</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span> -&gt; print(<span class="string">&quot;x == 0 or x == 1&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span> -&gt; print(<span class="string">&quot;otherwise&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">when</span> (x) &#123;</span><br><span class="line">    <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span> -&gt; print(<span class="string">&quot;x is in the range&quot;</span>)</span><br><span class="line">    <span class="keyword">in</span> validNumbers -&gt; print(<span class="string">&quot;x is valid&quot;</span>)</span><br><span class="line">    !<span class="keyword">in</span> <span class="number">10</span>..<span class="number">20</span> -&gt; print(<span class="string">&quot;x is outside the range&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span> -&gt; print(<span class="string">&quot;none of the above&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>回到任务本身。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">eval</span><span class="params">(e: <span class="type">Expr</span>)</span></span>: <span class="built_in">Int</span> =</span><br><span class="line">    <span class="keyword">when</span> (e) &#123;</span><br><span class="line">        <span class="keyword">is</span> Num -&gt; e.value</span><br><span class="line">        <span class="keyword">is</span> Sum -&gt; eval(e.left) + eval(e.right)</span><br><span class="line">        <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Unknown expression&quot;</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Extension-Functions">
          <a href="#Extension-Functions" class="heading-link"><i class="fas fa-link"></i></a>Extension Functions</h2>
      <p>kotlin 支持为已经存在的类编写扩展方法，而且不需要对原有类进行任何改动，只需要使用<code>className.extensionFun</code>的形式就可以了</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> String.<span class="title">lastChar</span><span class="params">()</span></span> = <span class="keyword">this</span>.<span class="keyword">get</span>(<span class="keyword">this</span>.length - <span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>

<p>任务要求为<code>Int</code>和<code>Pair&lt;Int, Int&gt;</code>分别实现一个扩展函数<code>r()</code>。<code>r()</code>函数的功能就是创建一个有理数。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">RationalNumber</span></span>(<span class="keyword">val</span> numerator: <span class="built_in">Int</span>, <span class="keyword">val</span> denominator: <span class="built_in">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="built_in">Int</span>.<span class="title">r</span><span class="params">()</span></span>: RationalNumber = RationalNumber(<span class="keyword">this</span>, <span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">fun</span> Pair<span class="type">&lt;Int, Int&gt;</span>.<span class="title">r</span><span class="params">()</span></span>: RationalNumber = RationalNumber(<span class="keyword">this</span>.first, <span class="keyword">this</span>.second)</span><br></pre></td></tr></table></div></figure>


        <h2 id="Object-Expression">
          <a href="#Object-Expression" class="heading-link"><i class="fas fa-link"></i></a>Object Expression</h2>
      <p>任务的要求是创建一个比较器（comparator），提供给 Collection 类对 list 按照降序排序。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task10</span><span class="params">()</span></span>: List&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> arrayList = arrayListOf(<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>)</span><br><span class="line">    Collections.sort(arrayList, <span class="keyword">object</span> : Comparator&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">compare</span><span class="params">(o1: <span class="type">Int</span>, o2: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> o2 - o1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> arrayList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="SAM-Conversions">
          <a href="#SAM-Conversions" class="heading-link"><i class="fas fa-link"></i></a>SAM Conversions</h2>
      <p>SAM conversions 就是如果一个 object 实现了一个 SAM（Single Abstract Method）接口时，可以直接传递一个 lambda 表达式。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task11</span><span class="params">()</span></span>: List&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> arrayList = arrayListOf(<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>)</span><br><span class="line">    arrayList.sortWith(Comparator &#123; x, y -&gt; y - x &#125;)</span><br><span class="line">    <span class="keyword">return</span> arrayList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Extensions-On-Collections">
          <a href="#Extensions-On-Collections" class="heading-link"><i class="fas fa-link"></i></a>Extensions On Collections</h2>
      <p>使用扩展函数<code>sortedDescending</code>重写上一个任务中的代码：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task12</span><span class="params">()</span></span>: List&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> arrayListOf(<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>).sortedDescending()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="Collections">
          <a href="#Collections" class="heading-link"><i class="fas fa-link"></i></a>Collections</h1>
      <p>这一模块主要是集合的一些任务，所有任务都是围绕一个商店（Shop）展开，商店有一个客户（Customer）列表。</p>
<p>客户具有姓名、城市和订单（Order）列表三个属性。</p>
<p>订单具有商品（Product）列表和是否已经发货两个属性。</p>
<p>商品具有名称和价格两个属性。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Shop</span></span>(<span class="keyword">val</span> name: String, <span class="keyword">val</span> customers: List&lt;Customer&gt;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span></span>(<span class="keyword">val</span> name: String, <span class="keyword">val</span> city: City, <span class="keyword">val</span> orders: List&lt;Order&gt;) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span> = <span class="string">&quot;<span class="variable">$name</span> from <span class="subst">$&#123;city.name&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span></span>(<span class="keyword">val</span> products: List&lt;Product&gt;, <span class="keyword">val</span> isDelivered: <span class="built_in">Boolean</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span></span>(<span class="keyword">val</span> name: String, <span class="keyword">val</span> price: <span class="built_in">Double</span>) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span> = <span class="string">&quot;&#x27;<span class="variable">$name</span>&#x27; for <span class="variable">$price</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">City</span></span>(<span class="keyword">val</span> name: String) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span> = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Introduction-1">
          <a href="#Introduction-1" class="heading-link"><i class="fas fa-link"></i></a>Introduction</h2>
      <p>要求返回一个 <code>Set</code>，包含商店中所有的客户：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getSetOfCustomers</span><span class="params">()</span></span>: Set&lt;Customer&gt; &#123;</span><br><span class="line">    <span class="comment">// Return a set containing all the customers of this shop</span></span><br><span class="line">    <span class="keyword">return</span> customers.toSet()</span><br><span class="line"><span class="comment">//    return this.customers</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Filter-Map">
          <a href="#Filter-Map" class="heading-link"><i class="fas fa-link"></i></a>Filter Map</h2>
      <p><code>filter</code> 方法返回一个包含所有满足指定条件元素的列表。</p>
<p>任务第一个要求返回指定城市所有客户的列表。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getCustomersFrom</span><span class="params">(city: <span class="type">City</span>)</span></span>: List&lt;Customer&gt; &#123;</span><br><span class="line">    <span class="comment">// Return a list of the customers who live in the given city</span></span><br><span class="line">    <span class="keyword">return</span> customers.filter &#123; it.city == city &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>map</code> 方法将指定的转换函数运用到原始集合的每一个元素，并返回一个转换后的集合。</p>
<p>任务第二个要求返回所有客户所在城市的 Set。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getCitiesCustomersAreFrom</span><span class="params">()</span></span>: Set&lt;City&gt; &#123;</span><br><span class="line">    <span class="comment">// Return the set of cities the customers are from</span></span><br><span class="line">    <span class="keyword">return</span> customers.map &#123; it.city &#125;.toSet()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="All-Any-and-others-Predicates">
          <a href="#All-Any-and-others-Predicates" class="heading-link"><i class="fas fa-link"></i></a>All Any and others Predicates</h2>
      <p><code>all</code>：如果所有的元素都满足指定的条件返回 true。</p>
<p><code>any</code>：如果至少有一个元素满足指定的条件返回 ture。</p>
<p><code>count</code>：返回满足指定条件的元素数量。</p>
<p><code>firstOrAll</code>：返回第一个满足指定条件的元素，如果没有就返回 null。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Customer.<span class="title">isFrom</span><span class="params">(city: <span class="type">City</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="comment">// Return true if the customer is from the given city</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.city == city</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">checkAllCustomersAreFrom</span><span class="params">(city: <span class="type">City</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="comment">// Return true if all customers are from the given city</span></span><br><span class="line">    <span class="keyword">return</span> customers.all &#123; it.isFrom(city) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">hasCustomerFrom</span><span class="params">(city: <span class="type">City</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="comment">// Return true if there is at least one customer from the given city</span></span><br><span class="line">    <span class="keyword">return</span> customers.any &#123; it.isFrom(city) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">countCustomersFrom</span><span class="params">(city: <span class="type">City</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="comment">// Return the number of customers from the given city</span></span><br><span class="line">    <span class="keyword">return</span> customers.count &#123; it.isFrom(city) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">findFirstCustomerFrom</span><span class="params">(city: <span class="type">City</span>)</span></span>: Customer? &#123;</span><br><span class="line">    <span class="comment">// Return the first customer who lives in the given city, or null if there is none</span></span><br><span class="line">    <span class="keyword">return</span> customers.firstOrNull &#123; it.isFrom(city) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="FlatMap">
          <a href="#FlatMap" class="heading-link"><i class="fas fa-link"></i></a>FlatMap</h2>
      <p><code>flatmap</code>：针对列表中的每一项根据指定的方法生成一个列表，最后将所有的列表拼接成一个列表返回。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回一个客户所有已订购的产品</span></span><br><span class="line"><span class="keyword">val</span> Customer.orderedProducts: Set&lt;Product&gt;</span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="comment">// Return all products this customer has ordered</span></span><br><span class="line">        <span class="keyword">return</span> orders.flatMap &#123; it.products &#125;.toSet()</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 返回所有至少被一个客户订购过的商品集合</span></span><br><span class="line"><span class="keyword">val</span> Shop.allOrderedProducts: Set&lt;Product&gt;</span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="comment">// Return all products that were ordered by at least one customer</span></span><br><span class="line">        <span class="keyword">return</span> customers.flatMap &#123; it.orderedProducts &#125;.toSet()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Max-Min">
          <a href="#Max-Min" class="heading-link"><i class="fas fa-link"></i></a>Max Min</h2>
      <p><code>max</code>：返回集合中最大的元素。如果没有元素则返回 null。</p>
<p><code>maxby</code>：使用函数参数计算的值作为比较对象。返回最大的元素中的值。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回商店中订单数目最多的一个客户。</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getCustomerWithMaximumNumberOfOrders</span><span class="params">()</span></span>: Customer? &#123;</span><br><span class="line">    <span class="comment">// Return a customer whose order count is the highest among all customers</span></span><br><span class="line">    <span class="keyword">return</span> customers.maxBy &#123; it.orders.size &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个客户所订购商品中价格最高的一个商品</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Customer.<span class="title">getMostExpensiveOrderedProduct</span><span class="params">()</span></span>: Product? &#123;</span><br><span class="line">    <span class="comment">// Return the most expensive product which has been ordered</span></span><br><span class="line">    <span class="keyword">return</span> orders.flatMap &#123; it.products &#125;.maxBy &#123; it.price &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Sort">
          <a href="#Sort" class="heading-link"><i class="fas fa-link"></i></a>Sort</h2>
      <p>kotlin 中可以通过 <code>sortby</code>指定排序的标准。</p>
<p>任务要求返回一个客户列表，客户的顺序是根据订单的数量由低到高。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getCustomersSortedByNumberOfOrders</span><span class="params">()</span></span>: List&lt;Customer&gt; &#123;</span><br><span class="line">    <span class="comment">// Return a list of customers, sorted by the ascending number of orders they made</span></span><br><span class="line">    <span class="keyword">return</span> customers.sortedBy &#123; it.orders.size &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Sum">
          <a href="#Sum" class="heading-link"><i class="fas fa-link"></i></a>Sum</h2>
      <p><code>sumby</code>：将集合中所有元素按照指定的函数变换以后的结果累加。</p>
<p>任务要求计算一个客户所有已订购商品的价格总和。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Customer.<span class="title">getTotalOrderPrice</span><span class="params">()</span></span>: <span class="built_in">Double</span> &#123;</span><br><span class="line">    <span class="comment">// Return the sum of prices of all products that a customer has ordered.</span></span><br><span class="line">    <span class="comment">// Note: a customer may order the same product several times.</span></span><br><span class="line">    <span class="keyword">return</span> orders.flatMap &#123; it.products &#125;.sumByDouble &#123; it.price &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="GroupBy">
          <a href="#GroupBy" class="heading-link"><i class="fas fa-link"></i></a>GroupBy</h2>
      <p><code>groupBy</code>方法返回一个根据指定条件分组好的 map。</p>
<p>任务要求返回来自每一个城市的客户的 map：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">groupCustomersByCity</span><span class="params">()</span></span>: Map&lt;City, List&lt;Customer&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// Return a map of the customers living in each city</span></span><br><span class="line">    <span class="keyword">return</span> customers.groupBy &#123; it.city &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Partition">
          <a href="#Partition" class="heading-link"><i class="fas fa-link"></i></a>Partition</h2>
      <p><code>partition</code>：将原始的集合分为一对集合，这一对集合中第一个是满足指定条件的元素集合，第二个是不满足指定条件的集合。</p>
<p>任务要求返回所有未发货订单数目多于已发货订单的用户。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getCustomersWithMoreUndeliveredOrdersThanDelivered</span><span class="params">()</span></span>: Set&lt;Customer&gt; &#123;</span><br><span class="line">    <span class="comment">// Return customers who have more undelivered orders than delivered</span></span><br><span class="line">    <span class="keyword">return</span> customers.filter &#123;</span><br><span class="line">        <span class="keyword">val</span> (delivered, undelivered) = it.orders.partition &#123; it.isDelivered &#125;</span><br><span class="line">        delivered.size &lt; undelivered.size</span><br><span class="line">    &#125;.toSet()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Fold">
          <a href="#Fold" class="heading-link"><i class="fas fa-link"></i></a>Fold</h2>
      <p><code>fold</code>：给定一个初始值，然后通过迭代对集合中的每一个元素执行指定的操作并将操作的结果累加。</p>
<p>任务要求返回所有客户都订购过的商品。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getSetOfProductsOrderedByEachCustomer</span><span class="params">()</span></span>: Set&lt;Product&gt; &#123;</span><br><span class="line">    <span class="comment">// Return the set of products that were ordered by each of the customers</span></span><br><span class="line">    <span class="keyword">return</span> customers.fold(allOrderedProducts, &#123; orderedByAll, customer -&gt;</span><br><span class="line">        orderedByAll.intersect(customer.orderedProducts)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></div></figure>


        <h2 id="CompoundTasks">
          <a href="#CompoundTasks" class="heading-link"><i class="fas fa-link"></i></a>CompoundTasks</h2>
      <p>上述方法的混合使用。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Customer.<span class="title">hasOrderedProduct</span><span class="params">(product: <span class="type">Product</span>)</span></span> = orders.any &#123; it.products.contains(product) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有购买了指定商品的客户列表</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getCustomersWhoOrderedProduct</span><span class="params">(product: <span class="type">Product</span>)</span></span>: Set&lt;Customer&gt; &#123;</span><br><span class="line">    <span class="comment">// Return the set of customers who ordered the specified product</span></span><br><span class="line">    <span class="keyword">return</span> customers.filter &#123; it.hasOrderedProduct(product) &#125;.toSet()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找某个用户所有已发货的商品中最昂贵的商品</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Customer.<span class="title">getMostExpensiveDeliveredProduct</span><span class="params">()</span></span>: Product? &#123;</span><br><span class="line">    <span class="comment">// Return the most expensive product among all delivered products</span></span><br><span class="line">    <span class="comment">// (use the Order.isDelivered flag)</span></span><br><span class="line">    <span class="keyword">return</span> orders.filter &#123; it.isDelivered &#125;.flatMap &#123; it.products &#125;.maxBy &#123; it.price &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找指定商品被购买的次数</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Shop.<span class="title">getNumberOfTimesProductWasOrdered</span><span class="params">(product: <span class="type">Product</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="comment">// Return the number of times the given product was ordered.</span></span><br><span class="line">    <span class="comment">// Note: a customer may order the same product for several times.</span></span><br><span class="line">    <span class="keyword">return</span> customers.flatMap &#123; it.orders.flatMap &#123; it.products &#125; &#125;.count &#123; it == product &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="Extensions-On-Collections-1">
          <a href="#Extensions-On-Collections-1" class="heading-link"><i class="fas fa-link"></i></a>Extensions On Collections</h2>
      <p>重写 Java 代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSomethingStrangeWithCollection</span><span class="params">(Collection&lt;String&gt; collection)</span> </span>&#123;</span><br><span class="line">    Map&lt;Integer, List&lt;String&gt;&gt; groupsByLength = Maps.newHashMap();</span><br><span class="line">    <span class="keyword">for</span> (String s : collection) &#123;</span><br><span class="line">        List&lt;String&gt; strings = groupsByLength.get(s.length());</span><br><span class="line">        <span class="keyword">if</span> (strings == <span class="keyword">null</span>) &#123;</span><br><span class="line">            strings = Lists.newArrayList();</span><br><span class="line">            groupsByLength.put(s.length(), strings);</span><br><span class="line">        &#125;</span><br><span class="line">        strings.add(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> maximumSizeOfGroup = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (List&lt;String&gt; group : groupsByLength.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (group.size() &gt; maximumSizeOfGroup) &#123;</span><br><span class="line">            maximumSizeOfGroup = group.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (List&lt;String&gt; group : groupsByLength.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (group.size() == maximumSizeOfGroup) &#123;</span><br><span class="line">            <span class="keyword">return</span> group;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>方法的目的是：</p>
<ul>
<li>将一个字符串集合按照长度分组，放入一个 map 中</li>
<li>求出 map 中所有元素 (String List) 的最大长度</li>
<li>根据步骤2的结果，返回 map 中字符串数目最多的那一组</li>
</ul>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">doSomethingStrangeWithCollection</span><span class="params">(collection: <span class="type">Collection</span>&lt;<span class="type">String</span>&gt;)</span></span>: Collection&lt;String&gt;? &#123;</span><br><span class="line">    <span class="keyword">val</span> groupsByLength = collection.groupBy &#123; s -&gt; s.length &#125;</span><br><span class="line">    <span class="keyword">return</span> groupsByLength.values.maxBy &#123; group -&gt; group.size &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="Conventions">
          <a href="#Conventions" class="heading-link"><i class="fas fa-link"></i></a>Conventions</h1>
      
        <h2 id="Comparsion">
          <a href="#Comparsion" class="heading-link"><i class="fas fa-link"></i></a>Comparsion</h2>
      <p>实现日期对象大小的比较</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task25</span><span class="params">(date1: <span class="type">MyDate</span>, date2: <span class="type">MyDate</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> date1 &lt; date2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>其中类 <code>MyDate</code>需要实现 <code>Comparable</code>接口。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDate</span></span>(<span class="keyword">val</span> year: <span class="built_in">Int</span>, <span class="keyword">val</span> month: <span class="built_in">Int</span>, <span class="keyword">val</span> dayOfMonth: <span class="built_in">Int</span>) : Comparable&lt;MyDate&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">compareTo</span><span class="params">(other: <span class="type">MyDate</span>)</span></span> =</span><br><span class="line">            <span class="keyword">when</span> &#123;</span><br><span class="line">                other.year != year -&gt; year - other.year</span><br><span class="line">                other.month != month -&gt; month - other.month</span><br><span class="line">                <span class="keyword">else</span> -&gt; dayOfMonth - other.dayOfMonth</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="InRange">
          <a href="#InRange" class="heading-link"><i class="fas fa-link"></i></a>InRange</h2>
      <p>实现检查指定的日期是不是在某一个日期范围内。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">checkInRange</span><span class="params">(date: <span class="type">MyDate</span>, first: <span class="type">MyDate</span>, last: <span class="type">MyDate</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> date <span class="keyword">in</span> DateRange(first, last)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>DateRange 类已经定义好，需要添加 <code>contains</code>函数。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DateRange</span></span>(<span class="keyword">val</span> start: MyDate, <span class="keyword">val</span> endInclusive: MyDate) &#123;</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">contains</span><span class="params">(value: <span class="type">MyDate</span>)</span></span>: <span class="built_in">Boolean</span> = start &lt;= value &amp;&amp; value &lt;= endInclusive</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="RangeTo">
          <a href="#RangeTo" class="heading-link"><i class="fas fa-link"></i></a>RangeTo</h2>
      <p>这一个任务是要求实现<code>MyDate</code>类的<code>..</code>运算符。<code>..</code>运算符最终会翻译成<code>rangeTo()</code>函数，所以本任务就是实现<code>MyDate.rangeTo()</code>。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> MyDate.<span class="title">rangeTo</span><span class="params">(other: <span class="type">MyDate</span>)</span></span>: DateRange = DateRange(<span class="keyword">this</span>, other)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">checkInRange2</span><span class="params">(date: <span class="type">MyDate</span>, first: <span class="type">MyDate</span>, last: <span class="type">MyDate</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="comment">//todoTask27()</span></span><br><span class="line">    <span class="keyword">return</span> date <span class="keyword">in</span> first..last</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="ForLoop">
          <a href="#ForLoop" class="heading-link"><i class="fas fa-link"></i></a>ForLoop</h2>
      <p>任务要求对 DateRange 内的 MyDate 执行 for 循环，因此 DateRange 需要实现 Iterable 接口。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DateRange</span></span>(<span class="keyword">val</span> start: MyDate, <span class="keyword">val</span> endInclusive: MyDate) : Iterable&lt;MyDate&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">iterator</span><span class="params">()</span></span>: Iterator&lt;MyDate&gt; = DateIterator(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">contains</span><span class="params">(value: <span class="type">MyDate</span>)</span></span>: <span class="built_in">Boolean</span> = start &lt;= value &amp;&amp; value &lt;= endInclusive</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DateIterator</span></span>(<span class="keyword">val</span> dateRange: DateRange) : Iterator&lt;MyDate&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> current: MyDate = dateRange.start</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">hasNext</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> = current &lt;= dateRange.endInclusive</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">next</span><span class="params">()</span></span>: MyDate &#123;</span><br><span class="line">        <span class="keyword">val</span> result = current</span><br><span class="line">        current = current.nextDay()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="OperatorOverloading">
          <a href="#OperatorOverloading" class="heading-link"><i class="fas fa-link"></i></a>OperatorOverloading</h2>
      <p>重载 <code>+</code>运算符：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> MyDate.<span class="title">plus</span><span class="params">(timeInterval: <span class="type">TimeInterval</span>)</span></span> = addTimeIntervals(timeInterval, <span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>

<p>重载<code>*</code>运算符：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将TimeInterval的乘法结果定义成RepeatedTimeInterval</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RepeatedTimeInterval</span></span>(<span class="keyword">val</span> timeInterval: TimeInterval, <span class="keyword">val</span> number: <span class="built_in">Int</span>)</span><br><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> TimeInterval.<span class="title">times</span><span class="params">(number: <span class="type">Int</span>)</span></span> = RepeatedTimeInterval(<span class="keyword">this</span>, number)</span><br><span class="line"></span><br><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> MyDate.<span class="title">plus</span><span class="params">(timeIntervals: <span class="type">RepeatedTimeInterval</span>)</span></span> = addTimeIntervals(timeIntervals.timeInterval, timeIntervals.number)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="Destructuring-Declaration">
          <a href="#Destructuring-Declaration" class="heading-link"><i class="fas fa-link"></i></a>Destructuring Declaration</h2>
      <p>kotlin 可以将一个对象的所有属性一次赋值给一堆变量</p>
<p>任务要求判断一个日期是否是闰年。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDate</span></span>(<span class="keyword">val</span> year: <span class="built_in">Int</span>, <span class="keyword">val</span> month: <span class="built_in">Int</span>, <span class="keyword">val</span> dayOfMonth: <span class="built_in">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">isLeapDay</span><span class="params">(date: <span class="type">MyDate</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> (year, month, dayOfMonth) = date</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 29 February of a leap year</span></span><br><span class="line">    <span class="keyword">return</span> isLeapYear(year) &amp;&amp; month == <span class="number">1</span> &amp;&amp; dayOfMonth == <span class="number">29</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Years which are multiples of four (with the exception of years divisible by 100 but not by 400)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">isLeapYear</span><span class="params">(year: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> = year % <span class="number">4</span> == <span class="number">0</span> &amp;&amp; (year % <span class="number">100</span> != <span class="number">0</span> || year % <span class="number">400</span> == <span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>


        <h2 id="Invoke">
          <a href="#Invoke" class="heading-link"><i class="fas fa-link"></i></a>Invoke</h2>
      <p>如果一个类实现了<code>invoke</code>函数，那么该类的实体对象在调用这个函数时可以省略函数名，<code>invoke</code>函数需要有<code>operator</code>修饰符。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task31</span><span class="params">(invokable: <span class="type">Invokable</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> invokable()()()().numberOfInvocations</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Invokable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> numberOfInvocations: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">()</span></span>: Invokable &#123;</span><br><span class="line">        numberOfInvocations++</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="Properties">
          <a href="#Properties" class="heading-link"><i class="fas fa-link"></i></a>Properties</h1>
      
        <h2 id="Properties-1">
          <a href="#Properties-1" class="heading-link"><i class="fas fa-link"></i></a>Properties</h2>
      <p>kotlin 中可以为属性自定义 setter，格式如下：</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertyExample</span></span>() &#123;</span><br><span class="line">    <span class="keyword">var</span> counter = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> propertyWithCounter: <span class="built_in">Int</span>? = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">            counter++</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>每次为 <code>propertyWithCounter</code> 赋值时，都会调用 <code>set</code>，kotlin 中不能直接声明字段，然而，当一个属性需要一个幕后字段时，Kotlin 会自动提供。这个幕后字段可以使用<code>field</code>标识符在访问器中引用。</p>

        <h2 id="LazyProperty">
          <a href="#LazyProperty" class="heading-link"><i class="fas fa-link"></i></a>LazyProperty</h2>
      <p><code>initializer</code>是一个<code>lambda </code>表达式，这个表达式会在<code>lazy</code>属性第一次被访问的时候执行，且仅执行一次</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LazyProperty</span></span>(<span class="keyword">val</span> initializer: () -&gt; <span class="built_in">Int</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> value: <span class="built_in">Int</span>? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">val</span> lazy: <span class="built_in">Int</span></span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            value = initializer()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value!!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="DelegatesExamples">
          <a href="#DelegatesExamples" class="heading-link"><i class="fas fa-link"></i></a>DelegatesExamples</h2>
      <p>用委托实现懒加载</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LazyPropertyUsingDelegates</span></span>(<span class="keyword">val</span> initializer: () -&gt; <span class="built_in">Int</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> lazyValue: <span class="built_in">Int</span> <span class="keyword">by</span> lazy(initializer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="HowDelegatesWork">
          <a href="#HowDelegatesWork" class="heading-link"><i class="fas fa-link"></i></a>HowDelegatesWork</h2>
      <figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EffectiveDate</span>&lt;<span class="type">R</span>&gt; : <span class="type">ReadWriteProperty</span>&lt;<span class="type">R, MyDate</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> timeInMillis: <span class="built_in">Long</span>? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="type">R</span>, property: <span class="type">KProperty</span>&lt;*&gt;)</span></span>: MyDate = timeInMillis!!.toDate()</span><br><span class="line">    <span class="keyword">operator</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(thisRef: <span class="type">R</span>, property: <span class="type">KProperty</span>&lt;*&gt;, value: <span class="type">MyDate</span>)</span></span> &#123; timeInMillis = value.toMillis() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="Builders">
          <a href="#Builders" class="heading-link"><i class="fas fa-link"></i></a>Builders</h1>
      
        <h2 id="ExtensionFunctionLiterals">
          <a href="#ExtensionFunctionLiterals" class="heading-link"><i class="fas fa-link"></i></a>ExtensionFunctionLiterals</h2>
      <figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task36</span><span class="params">()</span></span>: List&lt;<span class="built_in">Boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> isEven: <span class="built_in">Int</span>.() -&gt; <span class="built_in">Boolean</span> = &#123; <span class="keyword">this</span> % <span class="number">2</span> == <span class="number">0</span> &#125;</span><br><span class="line">    <span class="keyword">val</span> isOdd: <span class="built_in">Int</span>.() -&gt; <span class="built_in">Boolean</span> = &#123; <span class="keyword">this</span> % <span class="number">2</span> != <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> listOf(<span class="number">42</span>.isOdd(), <span class="number">239</span>.isOdd(), <span class="number">294823098</span>.isEven())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="StringAndMapBuilders">
          <a href="#StringAndMapBuilders" class="heading-link"><i class="fas fa-link"></i></a>StringAndMapBuilders</h2>
      <p>类型扩展函数，仿照<code>buildString</code>实现<code>buildMap</code></p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;K, V&gt;</span> <span class="title">buildMap</span><span class="params">(build: <span class="type">MutableMap</span>&lt;<span class="type">K</span>, V&gt;.()</span></span> -&gt; <span class="built_in">Unit</span>): Map&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> map = HashMap&lt;K, V&gt;()</span><br><span class="line">    map.build()</span><br><span class="line">    <span class="keyword">return</span> map</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">task37</span><span class="params">()</span></span>: Map&lt;<span class="built_in">Int</span>, String&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> buildMap &#123;</span><br><span class="line">        put(<span class="number">0</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span>) &#123;</span><br><span class="line">            put(i, <span class="string">&quot;<span class="variable">$i</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="TheFunctionApply">
          <a href="#TheFunctionApply" class="heading-link"><i class="fas fa-link"></i></a>TheFunctionApply</h2>
      <p>使用<code>apply</code>重写上一练习中的功能</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">myApply</span><span class="params">(f: <span class="type">T</span>.() -&gt; <span class="type">Unit</span>)</span></span>: T &#123;</span><br><span class="line">    f()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="HtmlBuilders">
          <a href="#HtmlBuilders" class="heading-link"><i class="fas fa-link"></i></a>HtmlBuilders</h2>
      <p>把<code>products</code>填充进表格，并设置好背景色，运行<code>htmlDemo.kt</code>可以预览内容</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">renderProductTable</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> html &#123;</span><br><span class="line">        table &#123;</span><br><span class="line">            tr &#123;</span><br><span class="line">                td &#123;</span><br><span class="line">                    text(<span class="string">&quot;Product&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                td &#123;</span><br><span class="line">                    text(<span class="string">&quot;Price&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                td &#123;</span><br><span class="line">                    text(<span class="string">&quot;Popularity&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">val</span> products = getProducts()</span><br><span class="line">            <span class="keyword">for</span> ((index, product) <span class="keyword">in</span> products.withIndex()) &#123;</span><br><span class="line">                tr &#123;</span><br><span class="line">                    td (color = getCellColor(index, <span class="number">0</span>)) &#123;</span><br><span class="line">                        text(product.description)</span><br><span class="line">                    &#125;</span><br><span class="line">                    td (color = getCellColor(index, <span class="number">1</span>)) &#123;</span><br><span class="line">                        text(product.price)</span><br><span class="line">                    &#125;</span><br><span class="line">                    td (color = getCellColor(index, <span class="number">2</span>)) &#123;</span><br><span class="line">                        text(product.popularity)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.toString()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="BuildersHowItWorks">
          <a href="#BuildersHowItWorks" class="heading-link"><i class="fas fa-link"></i></a>BuildersHowItWorks</h2>
      <p>1：c，<code>td</code>是一个方法，这里的<code>td</code>显然是在调用<br>2：b，<code>color</code>是参数名，这里使用了命名参数<br>3：b，这里是个<code>lambda</code>表达式<br>4：c，<code>this</code>指向调用者</p>

        <h1 id="Generics">
          <a href="#Generics" class="heading-link"><i class="fas fa-link"></i></a>Generics</h1>
      
        <h2 id="GenericsFunctions">
          <a href="#GenericsFunctions" class="heading-link"><i class="fas fa-link"></i></a>GenericsFunctions</h2>
      <p>根据条件将一个集合分为两个集合。</p>
<figure class="highlight kotlin"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, C: MutableCollection&lt;T&gt;</span>&gt; Collection<span class="type">&lt;T&gt;</span>.<span class="title">partitionTo</span><span class="params">(first: <span class="type">C</span>, second: <span class="type">C</span>, predicate: (<span class="type">T</span>) -&gt; <span class="type">Boolean</span>)</span></span>: Pair&lt;C, C&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (element <span class="keyword">in</span> <span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (predicate(element)) &#123;</span><br><span class="line">            first.add(element)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            second.add(element)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Pair(first, second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/3/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/5/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2020</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>贾小昆</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.1.1</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.xml';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script type="application/json" src="/search.xml"></script></body></html>